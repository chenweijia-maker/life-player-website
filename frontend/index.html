<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>äººç”Ÿç©å®¶</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- React & ReactDOM via CDNï¼ˆé‡Œç¨‹ç¢‘ 1 ç®€åŒ–ç‰ˆï¼‰ -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script crossorigin src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft YaHei", sans-serif;
        background: url('./assets/background.png') center center / cover no-repeat fixed;
        background-color: #667eea; /* å¤‡ç”¨èƒŒæ™¯è‰²ï¼Œå›¾ç‰‡åŠ è½½å‰çš„å ä½ */
        min-height: 100vh;
        padding: 24px;
        padding-top: env(safe-area-inset-top);
        padding-bottom: env(safe-area-inset-bottom);
        color: #333;
        /* iOS å®‰å…¨åŒºåŸŸé€‚é… */
        -webkit-tap-highlight-color: transparent;
      }
      .container {
        max-width: 1280px;
        margin: 0 auto;
        background: transparent;
        border-radius: 24px;
        padding: 24px 28px 32px;
        box-shadow: none;
        /* è®©ç™½è‰²èƒŒæ™¯è‡³å°‘é“ºæ»¡ä¸€å±ï¼Œé¿å…ä¸‹æ–¹å¤§å—ç•™ç©º */
        min-height: calc(100vh - 48px); /* body ä¸Šä¸‹å„ 24px padding */
      }
      /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
      @media (max-width: 768px) {
        body {
          padding: 12px;
        }
        .container {
          border-radius: 16px;
          padding: 16px 20px 24px;
        }
        .title {
          font-size: 20px;
        }
      }
      .title {
        font-size: 22px;
        font-weight: 700;
        margin-bottom: 16px;
      }
      .subtitle {
        font-size: 13px;
        color: #666;
        margin-bottom: 20px;
      }
      .auth-card {
        max-width: 520px;
        margin: 0 auto;
        padding: 28px 30px 30px;
        border-radius: 22px;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      .auth-card h2 {
        font-size: 22px;
        margin-bottom: 16px;
      }
      .auth-method-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }
      .auth-method-btn {
        flex: 1;
        padding: 12px 14px;
        border-radius: 12px;
        border: 1px solid rgba(255,255,255,0.4);
        background: rgba(255,255,255,0.15);
        color: #333;
        font-size: 14px;
        cursor: pointer;
        transition: background .2s, border-color .2s;
      }
      .auth-method-btn.active {
        background: rgba(102, 126, 234, 0.35);
        border-color: #667eea;
        color: #333;
      }
      .auth-method-btn:not(.active):hover {
        background: rgba(255,255,255,0.25);
      }
      .form-group {
        margin-bottom: 12px;
      }
      label {
        display: block;
        font-size: 13px;
        margin-bottom: 6px;
        color: #444;
      }
      input {
        width: 100%;
        padding: 12px 14px;
        border-radius: 10px;
        border: 1px solid #ccc;
        font-size: 14px;
      }
      /* ç™»å½•å¡ç‰‡å†…ï¼šé€‚ä¸­ä½†æ›´ç²¾è‡´ */
      .auth-card input {
        padding: 12px 14px;
        border-radius: 12px;
        font-size: 14px;
      }
      input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 1px rgba(102, 126, 234, 0.4);
      }
      .row {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      button {
        cursor: pointer;
      }
      .btn {
        border: none;
        border-radius: 999px;
        padding: 8px 14px;
        font-size: 13px;
        font-weight: 600;
        transition: all 0.2s ease;
      }
      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #fff;
      }
      .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 14px rgba(102, 126, 234, 0.7);
      }
      .btn-outline {
        background: transparent;
        border: 1px solid #667eea;
        color: #667eea;
      }
      .btn-outline:disabled,
      .btn-primary:disabled {
        opacity: 0.6;
        cursor: default;
        box-shadow: none;
        transform: none;
      }
      .error {
        margin-top: 10px;
        font-size: 13px;
        color: #c62828;
        text-align: center;
      }
      .hint {
        margin-top: 4px;
        font-size: 12px;
        color: #555;
      }
      /* å¤§å…å¸ƒå±€ */
      .dashboard {
        margin-top: 14px;
        display: grid;
        grid-template-columns: 320px 1fr 240px;
        gap: 20px;
      }
      .status-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 14px 18px;
        border-radius: 18px;
        background: rgba(255, 255, 255, 0.12);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        margin-bottom: 14px;
      }
      .user-info {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .avatar {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-weight: 700;
        font-size: 18px;
      }
      .user-meta {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }
      .user-meta-name {
        font-size: 14px;
        font-weight: 600;
      }
      .balance {
        font-size: 13px;
        color: #555;
      }
      .level-wrap {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .level-badge {
        padding: 4px 9px;
        border-radius: 999px;
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        font-size: 12px;
        color: #fff;
        font-weight: 600;
      }
      .exp-bar {
        width: 160px;
        height: 10px;
        border-radius: 999px;
        background: #e2e2e2;
        overflow: hidden;
      }
      .exp-fill {
        height: 100%;
        width: 40%;
        background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
        transition: width 0.2s ease;
      }
      .exp-label {
        font-size: 11px;
        color: #666;
        margin-left: 4px;
      }
      .status-amount {
        text-align: right;
        font-size: 13px;
      }
      .status-amount-main {
        font-weight: 600;
      }
      .status-amount-sub {
        font-size: 12px;
        color: #777;
      }
      .notif-bell {
        position: relative;
        border: none;
        background: transparent;
        cursor: pointer;
        padding: 4px 6px;
        font-size: 18px;
      }
      .notif-dot {
        position: absolute;
        top: 0;
        right: 0;
        min-width: 16px;
        height: 16px;
        padding: 0 4px;
        border-radius: 999px;
        background: #ef4444;
        color: #fff;
        font-size: 11px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .notif-list {
        margin-top: 8px;
        padding: 8px 10px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.12);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        max-height: 180px;
        overflow-y: auto;
        font-size: 12px;
      }
      .notif-item {
        padding: 4px 0;
        border-bottom: 1px solid #e5e7eb;
      }
      .notif-item:last-child {
        border-bottom: none;
      }
      .notif-item-title {
        font-weight: 600;
        margin-right: 4px;
      }
      /* äº”è¡Œé¢æ¿ */
      .panel {
        border-radius: 18px;
        padding: 16px 16px 18px;
        background: rgba(255, 255, 255, 0.12);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
      }
      .panel-title {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .pentagon {
        height: 220px;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
      }
      .attr-list {
        margin-top: 12px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 6px;
        font-size: 12px;
      }
      .attr-item {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 4px 6px;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(6px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      .attr-label {
        width: 70px;
      }
      .attr-bar {
        flex: 1;
        height: 6px;
        border-radius: 999px;
        background: #e0e0e0;
        overflow: hidden;
      }
      .attr-bar-fill {
        height: 100%;
        transition: width 0.3s ease;
      }
      .attr-value {
        width: 30px;
        text-align: right;
        font-size: 11px;
      }
      /* ä¸­å¤®æ¨¡å— & ä¾§è¾¹æ  */
      .modules {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 14px;
      }
      .card {
        border-radius: 16px;
        padding: 14px 14px 12px;
        background: rgba(255, 255, 255, 0.12);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
        font-size: 13px;
      }
      .card h3 {
        font-size: 14px;
        margin-bottom: 6px;
      }
      .card ul {
        list-style: none;
        margin-top: 6px;
      }
      .card li {
        padding: 4px 0;
        border-bottom: 1px solid #eee;
      }
      .card li:last-child {
        border-bottom: none;
      }
      .badge {
        display: inline-block;
        padding: 1px 6px;
        border-radius: 999px;
        background: #667eea;
        color: #fff;
        font-size: 11px;
        margin-left: 4px;
      }
      .sidebar {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .nav-card {
        border-radius: 16px;
        padding: 12px 14px;
        background: rgba(255, 255, 255, 0.12);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.06);
      }
      .nav-card h3 {
        font-size: 14px;
        margin-bottom: 8px;
      }
      .nav-list {
        list-style: none;
        font-size: 13px;
      }
      .nav-list li {
        padding: 6px 0;
        cursor: pointer;
      }
      .nav-list li:hover {
        color: #667eea;
      }
      @media (max-width: 1024px) {
        .dashboard {
          grid-template-columns: 1fr;
        }
      }
      /* é‡Œç¨‹ç¢‘ 3ï¼šä»»åŠ¡è¡Œä¸å®ŒæˆæŒ‰é’® */
      .task-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #eee;
        gap: 8px;
      }
      .task-row:last-child {
        border-bottom: none;
      }
      .task-row.done {
        opacity: 0.7;
      }
      .task-row.done .task-title {
        text-decoration: line-through;
        color: #888;
      }
      .task-row.completing .task-title {
        animation: taskComplete 0.5s ease;
      }
      @keyframes taskComplete {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); color: #16a34a; }
        100% { transform: scale(1); }
      }
      .task-title {
        flex: 1;
        font-size: 13px;
      }
      .btn-complete {
        padding: 4px 12px;
        border: none;
        border-radius: 999px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #fff;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
      }
      .btn-complete:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.5);
      }
      .btn-complete:disabled {
        opacity: 0.7;
        cursor: default;
      }
      /* å®Œæˆåé¦ˆå¼¹çª— */
      .feedback-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.4);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        animation: fadeIn 0.2s ease;
      }
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      .feedback-modal {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.25);
        border-radius: 20px;
        padding: 24px;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 20px 60px rgba(0,0,0,0.2);
        animation: slideUp 0.3s ease;
      }
      @keyframes slideUp {
        from { transform: translateY(20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }
      .feedback-modal h3 {
        font-size: 18px;
        margin-bottom: 16px;
        color: #333;
        text-align: center;
      }
      .feedback-rewards {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-bottom: 20px;
      }
      .feedback-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 14px;
      }
      .feedback-row.gain {
        color: #16a34a;
      }
      .feedback-attr {
        font-size: 12px;
        color: #666;
        margin-left: 8px;
      }
      .feedback-attr span {
        margin-right: 8px;
      }
      .feedback-achievement {
        background: rgba(102, 126, 234, 0.15);
        backdrop-filter: blur(6px);
        border: 1px solid rgba(102, 126, 234, 0.25);
        border-radius: 10px;
        padding: 10px 12px;
        margin-top: 8px;
        font-size: 13px;
      }
      .feedback-achievement strong {
        display: block;
        color: #667eea;
        margin-bottom: 4px;
      }
      .feedback-modal .btn-primary {
        width: 100%;
        padding: 12px;
        margin-top: 8px;
      }
      /* é‡Œç¨‹ç¢‘ 4ï¼šæŒ‘æˆ˜è¯¦æƒ…ä»ªè¡¨ç›˜ */
      .challenge-detail-overlay {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.4);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        animation: fadeIn 0.2s ease;
      }
      .challenge-detail-modal {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.25);
        border-radius: 20px;
        padding: 24px;
        max-width: 420px;
        width: 90%;
        max-height: 85vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0,0,0,0.2);
        animation: slideUp 0.3s ease;
      }
      .challenge-detail-modal h3 {
        font-size: 16px;
        margin-bottom: 4px;
        color: #333;
      }
      .challenge-detail-modal .subtitle {
        font-size: 12px;
        color: #666;
        margin-bottom: 16px;
      }
      .skill-dashboard {
        margin-top: 12px;
      }
      .skill-status-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 12px;
        border-radius: 10px;
        margin-bottom: 8px;
        font-size: 13px;
        background: rgba(255, 255, 255, 0.12);
        backdrop-filter: blur(6px);
        border: 1px solid rgba(255, 255, 255, 0.15);
      }
      .skill-status-row.met { background: rgba(22, 163, 74, 0.2); border-color: rgba(22, 163, 74, 0.3); }
      .skill-status-row.in_progress { background: rgba(234, 179, 8, 0.2); border-color: rgba(234, 179, 8, 0.3); }
      .skill-status-row.not_started { background: rgba(148, 163, 184, 0.2); border-color: rgba(148, 163, 184, 0.3); }
      .challenge-link {
        cursor: pointer;
        padding: 6px 0;
        border-bottom: 1px solid #eee;
        font-size: 13px;
      }
      .challenge-link:hover { color: #667eea; }
      .challenge-link:last-child { border-bottom: none; }
      /* é‡Œç¨‹ç¢‘ 5ï¼šè¡¥ç»™åŒ…å¡ç‰‡ã€äº”è¾¹å½¢å¤±è¡¡é¢„è­¦ */
      .supply-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #eee;
        font-size: 13px;
      }
      .supply-item:last-child { border-bottom: none; }
      .supply-use-btn {
        padding: 4px 10px;
        border: none;
        border-radius: 999px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #fff;
        font-size: 11px;
        cursor: pointer;
      }
      .supply-use-btn:disabled { opacity: 0.6; cursor: default; }
      .pentagon-wrap.imbalance .pentagon {
        animation: pentagonWarn 1.5s ease-in-out infinite;
      }
      .pentagon-wrap.imbalance svg { filter: drop-shadow(0 0 8px rgba(220, 38, 38, 0.6)); }
      @keyframes pentagonWarn {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.85; }
      }
      /* é‡Œç¨‹ç¢‘ 6ï¼šä½œæ¯é¡µã€æ”¯çº¿ä»»åŠ¡é¡µ */
      .schedule-page, .sidequest-page { padding: 20px 0; max-width: 560px; margin: 0 auto; }
      .schedule-buttons { display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; margin-bottom: 28px; }
      .schedule-btn {
        width: 160px; height: 160px; border-radius: 24px; border: none; font-size: 22px; font-weight: 700;
        cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px;
      }
      .schedule-btn.sleep { background: linear-gradient(135deg, #1e3a5f 0%, #0ea5e9 100%); color: #fff; }
      .schedule-btn.wake { background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%); color: #fff; }
      .schedule-btn:hover { transform: scale(1.05); box-shadow: 0 8px 24px rgba(0,0,0,0.2); }
      .schedule-btn:disabled { opacity: 0.7; cursor: default; transform: none; }
      .schedule-report {
        background: rgba(255, 255, 255, 0.12); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 16px; padding: 20px;
        font-size: 14px; color: #333;
      }
      .schedule-report h4 { margin-bottom: 12px; font-size: 15px; }
      .schedule-report p { margin: 6px 0; }
      .r90-heat { margin-top:12px; }
      .r90-heat-grid { display:grid; grid-template-columns: repeat(7, 1fr); gap:4px; margin-top:8px; }
      .r90-heat-cell { height:18px; border-radius:6px; background: rgba(255, 255, 255, 0.15); position:relative; overflow:hidden; }
      .r90-heat-cell-inner { position:absolute; inset:0; border-radius:inherit; }
      .r90-heat-cell-label { font-size:9px; color:#64748b; text-align:center; margin-top:4px; }
      .sidequest-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 16px; }
      .sidequest-card {
        background: rgba(255, 255, 255, 0.12); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 16px; padding: 18px; box-shadow: 0 4px 14px rgba(0,0,0,0.06);
        transition: transform 0.25s ease, box-shadow 0.25s ease; border: 2px solid transparent;
      }
      .sidequest-card:hover { transform: translateY(-4px); box-shadow: 0 12px 28px rgba(102, 126, 234, 0.15); border-color: rgba(102, 126, 234, 0.3); }
      .sidequest-card.done { opacity: 0.75; }
      .sidequest-card.done .sidequest-title { text-decoration: line-through; color: #888; }
      .sidequest-title { font-size: 15px; font-weight: 600; margin-bottom: 8px; }
      .sidequest-add { margin-bottom: 20px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
      .sidequest-add input { flex: 1; min-width: 160px; padding: 10px 14px; border-radius: 12px; border: 1px solid #ccc; font-size: 14px; }
      .view-back { margin-bottom: 16px; }
      .view-back .btn { padding: 8px 16px; font-size: 13px; }
      /* é‡Œç¨‹ç¢‘ 7ï¼šè´¢åŠ¡é¡µä¸å•†åŸ */
      .finance-page, .shop-page { padding: 20px 0; max-width: 860px; margin: 0 auto; }
      .finance-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
      .finance-card { background: rgba(255, 255, 255, 0.12); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 16px; padding: 16px; box-shadow: 0 4px 14px rgba(0,0,0,0.06); }
      .finance-card h4 { margin-bottom: 10px; font-size: 14px; }
      .progress { height: 10px; background: #e5e7eb; border-radius: 999px; overflow: hidden; }
      .progress > div { height: 100%; background: linear-gradient(90deg,#4facfe 0%,#00f2fe 100%); }
      .budget-bar { height: 10px; background: #e5e7eb; border-radius: 999px; overflow: hidden; }
      .budget-bar > div { height: 100%; background: linear-gradient(90deg,#667eea 0%,#764ba2 100%); }
      .tx-list { list-style: none; padding: 0; margin: 0; font-size: 13px; }
      .tx-list li { padding: 8px 0; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; gap: 10px; }
      .tx-list li:last-child { border-bottom: none; }
      .shop-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 16px; }
      .shop-item { background: rgba(255, 255, 255, 0.12); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 16px; padding: 16px; box-shadow: 0 4px 14px rgba(0,0,0,0.06); }
      .shop-item h4 { margin-bottom: 6px; }
      .shop-meta { font-size: 12px; color:#666; margin-bottom: 10px; }
      .redeem-btn { width:100%; margin-top: 10px; }
      .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.4); display:flex; align-items:center; justify-content:center; z-index:1100; }
      .modal { background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.25); border-radius: 18px; padding: 20px; width: 92%; max-width: 420px; box-shadow: 0 20px 60px rgba(0,0,0,0.2); }
      .modal h3 { margin-bottom: 10px; font-size: 16px; }
      .modal p { font-size: 13px; color:#444; margin: 6px 0; }
      .modal .actions { display:flex; gap:10px; margin-top: 14px; }
      .modal .actions .btn { flex:1; }
      /* é‡Œç¨‹ç¢‘ 8ï¼šå¨±ä¹ä¸å¤ç›˜ */
      .ent-page, .retro-page { padding: 20px 0; max-width: 680px; margin: 0 auto; }
      .ent-form { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 16px; }
      .retro-list { list-style:none; padding:0; margin:0; }
      .retro-list li { padding: 10px 0; border-bottom:1px solid #eee; }
      .retro-form { display:flex; flex-direction:column; gap:8px; margin-bottom:16px; }
      .retro-form textarea { width:100%; min-height:60px; padding:10px; border:1px solid #ccc; border-radius:10px; font-size:13px; }
      .mot-page { padding: 20px 0; max-width: 720px; margin: 0 auto; display:flex; flex-direction:column; gap:12px; }
      .mot-list { display:flex; flex-direction:column; gap:10px; }
      .mot-card { background: rgba(255, 255, 255, 0.12); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 16px; padding: 14px; box-shadow: 0 8px 20px rgba(0,0,0,0.06); }
      .mot-meta { font-size:11px; color:#64748b; margin-bottom:4px; }
      .mot-actions { display:flex; gap:8px; margin-top:8px; font-size:12px; color:#475569; }
      /* åŒæ¨¡å¼èåˆç¼–è¾‘å™¨ */
      .mix-toolbar { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:12px; }
      .mix-block { border: 1px solid rgba(255, 255, 255, 0.25); border-radius: 14px; padding: 12px; background: rgba(255, 255, 255, 0.12); backdrop-filter: blur(10px); }
      .mix-block { transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease, background .12s ease; }
      .mix-block:hover { border-color:#e6e6e6; box-shadow: 0 10px 24px rgba(20,30,60,0.06); }
      .mix-block.dragging { opacity: .7; transform: scale(.995); box-shadow: 0 14px 30px rgba(20,30,60,0.10); border-color: rgba(255,255,255,0.4); background: rgba(255, 255, 255, 0.2); }
      .mix-block + .mix-block { margin-top:10px; }
      .mix-block-head { display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:8px; }
      .mix-block-actions { display:flex; gap:6px; }
      .mix-mini { padding:6px 10px; font-size:12px; }
      .mix-insert { display:flex; gap:8px; justify-content:center; margin:8px 0; }
      .mix-dropzone { border:1px dashed transparent; border-radius:12px; padding:6px; background:transparent; transition: background .12s ease, border-color .12s ease, padding .12s ease; }
      .mix-dropzone .mix-insert { opacity:0; transform: translateY(-2px); pointer-events:none; transition: opacity .12s ease, transform .12s ease; }
      .mix-dropzone.hover { border-color: rgba(255,255,255,0.3); background: rgba(255, 255, 255, 0.08); }
      .mix-dropzone.hover .mix-insert { opacity:1; transform: translateY(0); pointer-events:auto; }
      .mix-dropzone.dragover { border-color: rgba(122, 167, 255, 0.6); background: rgba(238, 244, 255, 0.25); padding: 10px; }
      .mix-dropzone.dragover .mix-insert { opacity:1; transform: translateY(0); pointer-events:auto; }
      .mix-handle { cursor:grab; user-select:none; padding:6px 10px; border-radius:10px; border:1px solid rgba(255,255,255,0.3); background: rgba(255, 255, 255, 0.15); font-size:12px; color:#666; opacity:0; transform: translateY(-1px); transition: opacity .12s ease, transform .12s ease; }
      .mix-block:hover .mix-handle { opacity:1; transform: translateY(0); }
    </style>
  </head>
  <body>
    <div class="container">
      <div id="root">
        <div id="load-fallback" style="padding: 24px; text-align: center; color: #333; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border-radius: 16px; border: 1px solid rgba(255, 255, 255, 0.2);">
          <p style="margin-bottom: 12px;">åŠ è½½ä¸­â€¦</p>
          <p style="font-size: 13px; color: #666;">è‹¥ä¸€ç›´ç©ºç™½ï¼Œè¯·ç”¨æœ¬åœ°æœåŠ¡å™¨æ‰“å¼€ï¼š</p>
          <p style="font-size: 12px; color: #667eea; margin-top: 8px; font-weight: 600;">åœ¨ã€Œäººç”Ÿæ¸¸æˆã€ç›®å½•è¿è¡Œï¼šnpx serve frontend</p>
          <p style="font-size: 11px; color: #999; margin-top: 16px;">æˆ–æŒ‰ F12 æ‰“å¼€æ§åˆ¶å°æŸ¥çœ‹æ˜¯å¦æœ‰æŠ¥é”™</p>
        </div>
      </div>
    </div>

    <script type="text/babel">
      const { useState } = React;

      // ========== API é…ç½®å’Œ Capacitor åˆå§‹åŒ– ==========
      // API åŸºç¡€ URLï¼šæ”¯æŒå¤šç§é…ç½®æ–¹å¼
      const API_BASE_URL = (() => {
        // 1. ä¼˜å…ˆä½¿ç”¨ URL å‚æ•°ï¼ˆå¦‚ ?api=http://your-server.com:4000ï¼‰
        const urlParams = new URLSearchParams(window.location.search);
        const apiFromUrl = urlParams.get('api');
        if (apiFromUrl) {
          localStorage.setItem('api_base_url', apiFromUrl); // ä¿å­˜åˆ° localStorage
          return apiFromUrl;
        }
        
        // 2. å…¶æ¬¡ä½¿ç”¨ localStorage ä¸­ä¿å­˜çš„åœ°å€
        const apiFromStorage = localStorage.getItem('api_base_url');
        if (apiFromStorage) {
          return apiFromStorage;
        }
        
        // 3. æ£€æµ‹æ˜¯å¦åœ¨ Capacitor ç¯å¢ƒä¸­
        if (window.Capacitor && window.Capacitor.getPlatform() === 'ios') {
          // iOS ä¸­ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼ŒCapacitor ä¼šè‡ªåŠ¨å¤„ç†
          return '';
        }
        
        // 4. é»˜è®¤å€¼ï¼šWeb å¼€å‘ç¯å¢ƒä½¿ç”¨ localhost
        // å¦‚éœ€å…¬ç½‘è®¿é—®ï¼Œè¯·åœ¨ URL ä¸­æ·»åŠ  ?api=http://your-server.com:4000
        // æˆ–è¿è¡Œï¼šlocalStorage.setItem('api_base_url', 'http://your-server.com:4000')
        return 'http://localhost:4000';
      })();

      // API è¯·æ±‚è¾…åŠ©å‡½æ•°
      function apiUrl(path) {
        if (path.startsWith('/')) path = path.slice(1);
        if (!path.startsWith('api/')) path = 'api/' + path;
        return API_BASE_URL ? `${API_BASE_URL}/${path}` : `/${path}`;
      }

      // åˆå§‹åŒ– Capacitorï¼ˆå¦‚æœå¯ç”¨ï¼‰
      let Capacitor = null;
      if (window.Capacitor) {
        Capacitor = window.Capacitor;
        // é…ç½®çŠ¶æ€æ 
        if (Capacitor.Plugins && Capacitor.Plugins.StatusBar) {
          Capacitor.Plugins.StatusBar.setStyle({ style: 'light' });
          Capacitor.Plugins.StatusBar.setBackgroundColor({ color: '#667eea' });
        }
      }

      // å…¨å±€æ‹‰å–é€šçŸ¥å‡½æ•°ï¼Œä¾¿äºåœ¨æ§åˆ¶å°ç›´æ¥è°ƒç”¨è°ƒè¯•
      async function fetchNotifications() {
        const token = window.localStorage.getItem("token");
        if (!token) {
          console.warn("æœªç™»å½•ï¼Œç¼ºå°‘ token");
          return [];
        }
        const res = await fetch(apiUrl("notifications"), {
          method: "GET",
          headers: {
            Authorization: "Bearer " + token,
            "Content-Type": "application/json",
          },
        });
        if (!res.ok) {
          console.error("åŠ è½½é€šçŸ¥å¤±è´¥", await res.text());
          return [];
        }
        const data = await res.json();
        return data.notifications || [];
      }

      const ATTR_CONFIG = [
        { key: "wood", label: "æœ¨Â·å¥åº·", icon: "ğŸŒ³", color: "#16a34a" },
        { key: "fire", label: "ç«Â·ç²¾åŠ›", icon: "ğŸ”¥", color: "#f97316" },
        { key: "earth", label: "åœŸÂ·æ™ºæ…§", icon: "ğŸ”ï¸", color: "#eab308" },
        { key: "metal", label: "é‡‘Â·è´¢å¯Œ", icon: "â­", color: "#facc15" },
        { key: "water", label: "æ°´Â·å¿ƒæƒ…", icon: "ğŸ’§", color: "#0ea5e9" },
      ];

      const PHONE_REG = /^1\d{10}$/;
      function isValidPhone(v) {
        return typeof v === "string" && PHONE_REG.test(v.trim());
      }

      function LoginCard({ onLoggedIn }) {
        const [loginMethod, setLoginMethod] = useState("phone");
        const [phone, setPhone] = useState("");
        const [code, setCode] = useState("");
        const [nickname, setNickname] = useState("");
        const [sending, setSending] = useState(false);
        const [loggingIn, setLoggingIn] = useState(false);
        const [error, setError] = useState("");
        const [hint, setHint] = useState("");

        const sendCode = async () => {
          setError("");
          setHint("");
          const trimmed = (phone || "").trim();
          if (!trimmed) {
            setError("è¯·è¾“å…¥æ‰‹æœºå·");
            return;
          }
          if (!isValidPhone(trimmed)) {
            setError("è¯·è¾“å…¥æ­£ç¡®çš„ 11 ä½æ‰‹æœºå·ï¼ˆ1 å¼€å¤´ï¼‰");
            return;
          }
          try {
            setSending(true);
            const res = await fetch(apiUrl("auth/send-code"), {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ phone: trimmed }),
            });
            const data = await res.json();
            if (!data.success) {
              setError(data.error || "å‘é€éªŒè¯ç å¤±è´¥");
            } else {
              setHint("éªŒè¯ç å·²å‘é€åˆ°æ‚¨çš„æ‰‹æœº");
            }
          } catch (e) {
            setError("æ— æ³•è¿æ¥åç«¯ï¼Œè¯·ç¡®è®¤ backend å·²è¿è¡Œåœ¨ http://localhost:4000");
          } finally {
            setSending(false);
          }
        };

        const login = async () => {
          setError("");
          const trimmed = (phone || "").trim();
          if (!trimmed || !code) {
            setError("è¯·è¾“å…¥æ‰‹æœºå·å’ŒéªŒè¯ç ");
            return;
          }
          if (!isValidPhone(trimmed)) {
            setError("è¯·è¾“å…¥æ­£ç¡®çš„ 11 ä½æ‰‹æœºå·");
            return;
          }
          try {
            setLoggingIn(true);
            const res = await fetch(apiUrl("auth/login"), {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ phone: trimmed, code, nickname: nickname.trim() || undefined }),
            });
            const data = await res.json();
            if (!data.success) {
              setError(data.error || "ç™»å½•å¤±è´¥");
            } else {
              onLoggedIn(data.token, data.user);
            }
          } catch (e) {
            setError("æ— æ³•è¿æ¥åç«¯ï¼Œè¯·ç¡®è®¤ backend å·²è¿è¡Œåœ¨ http://localhost:4000");
          } finally {
            setLoggingIn(false);
          }
        };

        const tryWechat = async () => {
          setError("");
          try {
            const res = await fetch(apiUrl("auth/wechat"), {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({}),
            });
            const data = await res.json();
            setError(data.error || "å¾®ä¿¡ç™»å½•å³å°†ä¸Šçº¿ï¼Œè¯·å…ˆä½¿ç”¨æ‰‹æœºå·ç™»å½•");
          } catch (e) {
            setError("æ— æ³•è¿æ¥åç«¯ï¼Œè¯·ç¨åå†è¯•");
          }
        };

        const tryQQ = async () => {
          setError("");
          try {
            const res = await fetch(apiUrl("auth/qq"), {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({}),
            });
            const data = await res.json();
            setError(data.error || "QQ ç™»å½•å³å°†ä¸Šçº¿ï¼Œè¯·å…ˆä½¿ç”¨æ‰‹æœºå·ç™»å½•");
          } catch (e) {
            setError("æ— æ³•è¿æ¥åç«¯ï¼Œè¯·ç¨åå†è¯•");
          }
        };

        return (
          <div className="auth-card" autoComplete="off">
            <h2>ç™»å½•äººç”Ÿç©å®¶</h2>
            <div className="auth-method-tabs">
              <button
                type="button"
                className={"auth-method-btn " + (loginMethod === "phone" ? "active" : "")}
                onClick={() => { setLoginMethod("phone"); setError(""); setHint(""); }}
              >
                æ‰‹æœºå·
              </button>
              <button
                type="button"
                className={"auth-method-btn " + (loginMethod === "wechat" ? "active" : "")}
                onClick={() => { setLoginMethod("wechat"); setError(""); setHint(""); }}
              >
                å¾®ä¿¡
              </button>
              <button
                type="button"
                className={"auth-method-btn " + (loginMethod === "qq" ? "active" : "")}
                onClick={() => { setLoginMethod("qq"); setError(""); setHint(""); }}
              >
                QQ
              </button>
            </div>

            {loginMethod === "phone" && (
              <React.Fragment>
                <div className="form-group">
                  <label>æ‰‹æœºå·</label>
                  <input
                    autoComplete="off"
                    value={phone}
                    onChange={(e) => setPhone(e.target.value)}
                    placeholder="è¯·è¾“å…¥ 11 ä½æ‰‹æœºå·"
                    maxLength={11}
                    inputMode="numeric"
                  />
                </div>
                <div className="form-group">
                  <label>æ˜µç§°ï¼ˆå¯é€‰ï¼‰</label>
                  <input
                    autoComplete="off"
                    value={nickname}
                    onChange={(e) => setNickname(e.target.value)}
                    placeholder="ç”¨äºåœ¨æ¸¸æˆä¸­å±•ç¤ºçš„åå­—"
                  />
                </div>
                <div className="form-group">
                  <label>éªŒè¯ç </label>
                  <div className="row" style={{ flexWrap: "nowrap" }}>
                    <input
                      type="text"
                      inputMode="numeric"
                      maxLength={6}
                      autoComplete="one-time-code"
                      value={code}
                      onChange={(e) => setCode(e.target.value)}
                      placeholder="6 ä½éªŒè¯ç "
                      style={{ flex: 1, minWidth: 0, position: "relative", zIndex: 1 }}
                    />
                    <button
                      type="button"
                      className="btn btn-outline"
                      onClick={sendCode}
                      disabled={sending}
                    >
                      {sending ? "å‘é€ä¸­..." : "å‘é€éªŒè¯ç "}
                    </button>
                  </div>
                </div>
                <button
                  className="btn btn-primary"
                  style={{ width: "100%", marginTop: 8 }}
                  onClick={login}
                  disabled={loggingIn}
                >
                  {loggingIn ? "ç™»å½•ä¸­..." : "å¼€å§‹æ¸¸æˆ"}
                </button>
              </React.Fragment>
            )}

            {loginMethod === "wechat" && (
              <button
                className="btn btn-primary"
                style={{ width: "100%", marginTop: 0 }}
                onClick={tryWechat}
              >
                å¾®ä¿¡æˆæƒç™»å½•
              </button>
            )}

            {loginMethod === "qq" && (
              <button
                className="btn btn-primary"
                style={{ width: "100%", marginTop: 0 }}
                onClick={tryQQ}
              >
                QQ æˆæƒç™»å½•
              </button>
            )}

            {error && <div className="error">{error}</div>}
            {hint && <div className="hint">{hint}</div>}
          </div>
        );
      }

      function AttributePanel({ attributes }) {
        // é‡Œç¨‹ç¢‘ 1ï¼šç”¨ SVG ç”»ä¸€ä¸ªç®€æ˜“äº”è¾¹å½¢é›·è¾¾å›¾ï¼ˆ0-100 æ˜ å°„åˆ°åŠå¾„ï¼‰
        var baseAttrs = {
          wood: 60,
          fire: 60,
          earth: 60,
          metal: 60,
          water: 60,
        };
        var src = attributes || baseAttrs;
        var woodVal =
          typeof src.wood === "number" ? src.wood : baseAttrs.wood;
        var fireVal =
          typeof src.fire === "number" ? src.fire : baseAttrs.fire;
        var earthVal =
          typeof src.earth === "number" ? src.earth : baseAttrs.earth;
        var metalVal =
          typeof src.metal === "number" ? src.metal : baseAttrs.metal;
        var waterVal =
          typeof src.water === "number" ? src.water : baseAttrs.water;

        function clamp(v) {
          if (v < 0) return 0;
          if (v > 100) return 100;
          return v;
        }

        woodVal = clamp(woodVal);
        fireVal = clamp(fireVal);
        earthVal = clamp(earthVal);
        metalVal = clamp(metalVal);
        waterVal = clamp(waterVal);

        // è®©é¡¶ç‚¹æ–‡å­—ä¸è¢«è£åˆ‡ï¼šåŠ å¤§ç”»å¸ƒã€ä¸­å¿ƒä¸‹ç§»
        var cx = 80;
        var cy = 82;
        var maxR = 60;

        function pointFor(value, index) {
          // é¡¶ç‚¹ä»æ­£ä¸Šæ–¹å¼€å§‹ï¼Œé¡ºæ—¶é’ˆ 5 ä¸ªç‚¹
          var angleDeg = -90 + index * 72;
          var angleRad = (angleDeg * Math.PI) / 180;
          var r = (value / 100) * maxR;
          var x = cx + r * Math.cos(angleRad);
          var y = cy + r * Math.sin(angleRad);
          return x + "," + y;
        }

        function labelPointFor(index) {
          // æ ‡ç­¾ç‚¹ï¼šåœ¨é¡¶ç‚¹å¤–ä¾§ä¸€ç‚¹ç‚¹
          var angleDeg = -90 + index * 72;
          var angleRad = (angleDeg * Math.PI) / 180;
          var r = maxR + 14;
          return { x: cx + r * Math.cos(angleRad), y: cy + r * Math.sin(angleRad) };
        }

        var pWood = pointFor(woodVal, 0);
        var pFire = pointFor(fireVal, 1);
        var pEarth = pointFor(earthVal, 2);
        var pMetal = pointFor(metalVal, 3);
        var pWater = pointFor(waterVal, 4);

        var radarPoints =
          pWood + " " + pFire + " " + pEarth + " " + pMetal + " " + pWater;

        var vals = [woodVal, fireVal, earthVal, metalVal, waterVal];
        var minV = Math.min.apply(null, vals);
        var maxV = Math.max.apply(null, vals);
        var imbalance = minV < 30 || (maxV - minV) > 50;

        return (
          <div className="panel">
            <div className="panel-title">
              <span>äº”è¡Œå±æ€§</span>
              {imbalance && <span style={{ fontSize: 11, color: "#dc2626" }}>âš  å¤±è¡¡</span>}
              {!imbalance && <span style={{ fontSize: 11, color: "#666" }}>ç®€æ´æ¨¡å¼</span>}
            </div>
            <div className={"pentagon-wrap" + (imbalance ? " imbalance" : "")}>
            <div className="pentagon">
              <svg width="190" height="190" style={{ overflow: "visible" }}>
                {/* åº•å±‚ç½‘æ ¼äº”è¾¹å½¢ */}
                <g
                  transform="translate(15,15)"
                  stroke="#d1d5db"
                  strokeWidth="1"
                  fill="none"
                >
                  <polygon
                    points={pointFor(100, 0) +
                      " " +
                      pointFor(100, 1) +
                      " " +
                      pointFor(100, 2) +
                      " " +
                      pointFor(100, 3) +
                      " " +
                      pointFor(100, 4)}
                    fill="rgba(148,163,184,0.08)"
                  />
                  <polygon
                    points={pointFor(70, 0) +
                      " " +
                      pointFor(70, 1) +
                      " " +
                      pointFor(70, 2) +
                      " " +
                      pointFor(70, 3) +
                      " " +
                      pointFor(70, 4)}
                  />
                  <polygon
                    points={pointFor(40, 0) +
                      " " +
                      pointFor(40, 1) +
                      " " +
                      pointFor(40, 2) +
                      " " +
                      pointFor(40, 3) +
                      " " +
                      pointFor(40, 4)}
                  />
                </g>
                {/* å®é™…å±æ€§å¤šè¾¹å½¢ */}
                <g transform="translate(15,15)">
                  <polygon
                    points={radarPoints}
                    fill="rgba(102,126,234,0.45)"
                    stroke="#4f46e5"
                    strokeWidth="2"
                  />
                  <circle cx={cx} cy={cy} r="3" fill="#4f46e5" />
                </g>
                {/* äº”ä¸ªé¡¶ç‚¹æ˜¾ç¤ºå±æ€§ */}
                <g transform="translate(15,15)" fill="#374151">
                  {(() => {
                    var points = [
                      { name: "æœ¨", label: "å¥åº·", value: woodVal, idx: 0 },
                      { name: "ç«", label: "ç²¾åŠ›", value: fireVal, idx: 1 },
                      { name: "åœŸ", label: "æ™ºæ…§", value: earthVal, idx: 2 },
                      { name: "é‡‘", label: "è´¢å¯Œ", value: metalVal, idx: 3 },
                      { name: "æ°´", label: "å¿ƒæƒ…", value: waterVal, idx: 4 },
                    ];
                    return points.map(function (p) {
                      var pt = labelPointFor(p.idx);
                      return (
                        <text
                          key={p.name}
                          x={pt.x}
                          y={pt.y}
                          textAnchor="middle"
                          dominantBaseline="middle"
                          style={{ fontSize: 11, fontWeight: 700 }}
                        >
                          {p.name}{p.label} {p.value}
                        </text>
                      );
                    });
                  })()}
                </g>
              </svg>
            </div>
            </div>
            <div className="attr-list">
              {ATTR_CONFIG.map((cfg) => {
                const raw =
                  attributes && typeof attributes[cfg.key] === "number"
                    ? attributes[cfg.key]
                    : 60;
                const value = Math.max(0, Math.min(100, raw));
                return (
                  <div key={cfg.key} className="attr-item">
                    <div className="attr-label">
                      {cfg.icon} {cfg.label}
                    </div>
                    <div className="attr-bar">
                      <div
                        className="attr-bar-fill"
                        style={{
                          width: `${value}%`,
                          background: cfg.color,
                        }}
                      />
                    </div>
                    <div className="attr-value">{value}</div>
                  </div>
                );
              })}
            </div>
          </div>
        );
      }

      const ATTR_NAMES = { wood: "æœ¨Â·å¥åº·", fire: "ç«Â·ç²¾åŠ›", earth: "åœŸÂ·æ™ºæ…§", metal: "é‡‘Â·è´¢å¯Œ", water: "æ°´Â·å¿ƒæƒ…" };

      function Dashboard({ token, user }) {
        const [home, setHome] = useState(null);
        const [error, setError] = useState("");
        const [plan, setPlan] = useState(null);
        const [planError, setPlanError] = useState("");
        const [refreshCounter, setRefreshCounter] = useState(0);
        const [completingTaskId, setCompletingTaskId] = useState(null);
        const [feedbackData, setFeedbackData] = useState(null);
        const [challengeDetail, setChallengeDetail] = useState(null);
        const [loadingChallengeId, setLoadingChallengeId] = useState(null);
        const [usingSupplyId, setUsingSupplyId] = useState(null);
        const [view, setView] = useState("main");
        const [scheduleSummary, setScheduleSummary] = useState(null);
        const [sideQuests, setSideQuests] = useState([]);
        const [scheduleLogging, setScheduleLogging] = useState(null);
        const [r90WakeTime, setR90WakeTime] = useState("07:30");
        const [r90Options, setR90Options] = useState([]);
        const [r90TargetCycles, setR90TargetCycles] = useState(5);
        const [r90LastReport, setR90LastReport] = useState(null);
        const [r90Overview, setR90Overview] = useState(null);
        const [r90DayDetail, setR90DayDetail] = useState(null);
        const [finance, setFinance] = useState(null);
        const [shopItems, setShopItems] = useState([]);
        const [redeemItem, setRedeemItem] = useState(null);
        const [redeeming, setRedeeming] = useState(false);
        const [shopTab, setShopTab] = useState("official"); // official | wish
        const [wishList, setWishList] = useState([]); // å…ˆç”¨å‰ç«¯çŠ¶æ€æ‰¿æ¥ï¼Œåç»­æ¥åç«¯
        const [wishForm, setWishForm] = useState(null); // {id?, name, description, category, targetCoins, estimatedRmb}
        const [wishSaving, setWishSaving] = useState(null); // å½“å‰å‚¨è“„ä¸­çš„å¿ƒæ„¿ idï¼ˆé¢„ç•™ï¼‰
        const [motivationTab, setMotivationTab] = useState("recommend"); // recommend | milestone | mine | capsule
        const [motivationPosts, setMotivationPosts] = useState([]);
        const [motivationInput, setMotivationInput] = useState("");
        const [motivationLoading, setMotivationLoading] = useState(false);
        const [capsules, setCapsules] = useState([]);
        const [capsuleForm, setCapsuleForm] = useState({ title: "", message: "", openAt: "" });
        const [entLogs, setEntLogs] = useState([]);
        const [retrospectHistory, setRetrospectHistory] = useState([]);
        const [retroPatterns, setRetroPatterns] = useState([]);
        const [showQuickRetro, setShowQuickRetro] = useState(false);
        const [tplMine, setTplMine] = useState([]);
        const [tplSystem, setTplSystem] = useState([]);
        const [tplPublic, setTplPublic] = useState([]);
        const [selectedTemplateId, setSelectedTemplateId] = useState(null);
        const [templateDraft, setTemplateDraft] = useState(null); // {id?, title, description, category, isPublic, questions:[]}
        const [fillAnswers, setFillAnswers] = useState({}); // {questionId: answer}
        const [retroRatingAvg, setRetroRatingAvg] = useState(null);
        const [retroMode, setRetroMode] = useState("guided"); // guided | free_text
        const [mixBlocks, setMixBlocks] = useState([]); // [{id,type:'question'|'free', qType?, question?, answer?, content?}]
        const [freeText, setFreeText] = useState("");
        const [retroHistoryV2, setRetroHistoryV2] = useState([]);
        const [mixDragId, setMixDragId] = useState(null);
        const [mixDropIndex, setMixDropIndex] = useState(null);
        const [mixHoverInsertIndex, setMixHoverInsertIndex] = useState(null);
        const [strategicNodes, setStrategicNodes] = useState([]);
        const [planView, setPlanView] = useState("list"); // list | progress
        const [showSupplyModal, setShowSupplyModal] = useState(false);
        const [savingSupply, setSavingSupply] = useState(false);
        const [supplyForm, setSupplyForm] = useState({
          scenario: "",
          name: "",
          description: "",
          effects: { wood: 0, fire: 0, earth: 0, metal: 0, water: 0 },
          cooldownMinutes: 0,
        });
        const [notifications, setNotifications] = useState([]);
        const [showNotifications, setShowNotifications] = useState(false);
        const [friendFeed, setFriendFeed] = useState([]);
        const [friendFeedLoading, setFriendFeedLoading] = useState(false);
        const [friendFeedError, setFriendFeedError] = useState("");

        async function loadNotifications() {
          try {
            const data = await fetchNotifications();
            if (Array.isArray(data)) {
              setNotifications(data);
            }
          } catch (e) {
            // é€šçŸ¥å¤±è´¥æ—¶é™é»˜ï¼Œä¸é˜»å¡å…¶å®ƒåŠŸèƒ½
          }
        }

        const refreshHome = () => setRefreshCounter((c) => c + 1);
        const openChallengeDetail = async function (challengeId) {
          setLoadingChallengeId(challengeId);
          setChallengeDetail(null);
          try {
            const res = await fetch(apiUrl("challenges/" + challengeId + "/detail"), {
              headers: { Authorization: "Bearer " + token },
            });
            const data = await res.json();
            if (data.error) alert(data.error);
            else setChallengeDetail(data);
          } catch (e) {
            alert("åŠ è½½æŒ‘æˆ˜è¯¦æƒ…å¤±è´¥ï¼Œè¯·ç¡®è®¤åç«¯å·²è¿è¡Œ");
          } finally {
            setLoadingChallengeId(null);
          }
        };

        React.useEffect(() => {
          async function fetchHome() {
            try {
              const res = await fetch(apiUrl("home"), {
                headers: { Authorization: `Bearer ${token}` },
              });
              const data = await res.json();
              if (data.error) {
                setError(data.error);
              } else {
                setHome(data);
              }
            } catch (e) {
              setError("æ— æ³•åŠ è½½ä¸»é¡µæ•°æ®ï¼Œè¯·ç¡®è®¤ backend å·²è¿è¡Œ");
            }
          }
          fetchHome();
        }, [token, refreshCounter]);

        React.useEffect(() => {
          if (!token) return;
          loadNotifications();
        }, [token, refreshCounter]);

        React.useEffect(() => {
          if (!token || view !== "main") return;
          var aborted = false;
          (async function () {
            setFriendFeedLoading(true);
            setFriendFeedError("");
            try {
              const res = await fetch(apiUrl("friends/feed"), {
                headers: { Authorization: "Bearer " + token },
              });
              if (!res.ok) {
                const text = await res.text();
                const hint =
                  res.status === 404
                    ? "ï¼ˆå¾ˆå¯èƒ½åç«¯æœªæ›´æ–°/æœªé‡å¯ï¼Œæˆ–æ­£åœ¨è·‘æ—§ç‰ˆ server.jsï¼‰"
                    : "";
                throw new Error(`HTTP ${res.status} ${hint} ${text || ""}`.trim());
              }
              const data = await res.json();
              if (!aborted) {
                setFriendFeed(data && Array.isArray(data.feed) ? data.feed : []);
              }
            } catch (e) {
              if (!aborted) {
                setFriendFeedError("æ— æ³•åŠ è½½å¥½å‹åŠ¨æ€ï¼š" + (e && e.message ? e.message : "è¯·ç¨åå†è¯•"));
              }
            } finally {
              if (!aborted) setFriendFeedLoading(false);
            }
          })();
          return function () {
            aborted = true;
          };
        }, [token, view, refreshCounter]);

        React.useEffect(() => {
          if (view !== "plan") return;
          async function fetchStrategic() {
            try {
              const res = await fetch(apiUrl("strategic-nodes"), { headers: { Authorization: "Bearer " + token } });
              const data = await res.json();
              if (!data.error && data.nodes) setStrategicNodes(data.nodes || []);
            } catch (e) { setPlanError("æ— æ³•åŠ è½½æˆ˜ç•¥æ²™ç›˜ï¼Œè¯·æ£€æŸ¥åç«¯æ˜¯å¦è¿è¡Œ"); }
          }
          fetchStrategic();
        }, [token, view]);

        // åŠ è½½é‡Œç¨‹ç¢‘ 2 çš„æ¦‚è§ˆæ•°æ®ï¼ˆäººç”Ÿæ°´æ™¶ / Boss / æŒ‘æˆ˜ / æŠ€èƒ½ï¼‰
        React.useEffect(() => {
          async function fetchPlan() {
            try {
              const res = await fetch(apiUrl("plan/overview"), {
                headers: { Authorization: "Bearer " + token },
              });
              const data = await res.json();
              if (data.error) {
                setPlanError(data.error);
              } else {
                setPlan(data);
              }
            } catch (e) {
              setPlanError("æ— æ³•åŠ è½½ç›®æ ‡ä¸æŒ‘æˆ˜æ•°æ®ï¼ˆé‡Œç¨‹ç¢‘ 2 å ä½ï¼‰");
            }
          }
          fetchPlan();
        }, [token]);

        React.useEffect(() => {
          if (view !== "schedule") return;
          async function fetchSummary() {
            try {
              const res = await fetch(apiUrl("schedule/summary"), { headers: { Authorization: "Bearer " + token } });
              const data = await res.json();
              if (!data.error) setScheduleSummary(data);
            } catch (e) {}
          }
          fetchSummary();
        }, [token, view]);

        React.useEffect(() => {
          if (view !== "sideQuests") return;
          async function fetchSideQuests() {
            try {
              const res = await fetch(apiUrl("tasks?type=æ”¯çº¿"), { headers: { Authorization: "Bearer " + token } });
              const data = await res.json();
              if (!data.error) setSideQuests(data.tasks || []);
            } catch (e) {}
          }
          fetchSideQuests();
        }, [token, view]);

        React.useEffect(() => {
          if (view !== "finance") return;
          async function fetchFinance() {
            try {
              const res = await fetch(apiUrl("finance/overview"), { headers: { Authorization: "Bearer " + token } });
              const data = await res.json();
              if (!data.error) setFinance(data);
            } catch (e) {}
          }
          fetchFinance();
        }, [token, view]);

        React.useEffect(() => {
          if (view !== "shop") return;
          async function fetchShop() {
            try {
              const res = await fetch(apiUrl("reward-items"));
              const data = await res.json();
              if (data.rewardItems) setShopItems(data.rewardItems);
              const fin = await fetch(apiUrl("finance/overview"), { headers: { Authorization: "Bearer " + token } });
              const finData = await fin.json();
              if (!finData.error) setFinance(finData);
            } catch (e) {}
          }
          fetchShop();
        }, [token, view]);

        React.useEffect(() => {
          if (view !== "entertainment") return;
          async function fetchEnt() {
            try {
              const res = await fetch(apiUrl("entertainment/logs"), { headers: { Authorization: "Bearer " + token } });
              const data = await res.json();
              if (!data.error && data.logs) setEntLogs(data.logs);
            } catch (e) {}
          }
          fetchEnt();
        }, [token, view]);

        React.useEffect(() => {
          if (view !== "retrospect") return;
          async function fetchRetro() {
            try {
              const res = await fetch(apiUrl("retrospects/v2"), { headers: { Authorization: "Bearer " + token } });
              const data = await res.json();
              if (!data.error) {
                setRetroHistoryV2(data.retrospects || []);
                setRetroPatterns(data.patterns || []);
                setRetroRatingAvg(data.ratingAvg || null);
              }
              const tRes = await fetch(apiUrl("retrospect-templates"), { headers: { Authorization: "Bearer " + token } });
              const tData = await tRes.json();
              if (!tData.error) {
                setTplMine(tData.mine || []);
                setTplSystem(tData.system || []);
                const last = window.localStorage.getItem("lastTemplateId");
                const fallbackId = last ? Number(last) : ((tData.mine && tData.mine[0] && tData.mine[0].id) || (tData.system && tData.system[0] && tData.system[0].id) || 1);
                setSelectedTemplateId(fallbackId);
              }
            } catch (e) {}
          }
          fetchRetro();
        }, [token, view]);

        React.useEffect(() => {
          if (view !== "schedule") return;
          async function fetchR90() {
            try {
              const rec = await fetch(apiUrl("schedule/r90/recommendations"), { headers: { Authorization: "Bearer " + token } });
              const data = await rec.json();
              if (!data.error) {
                setR90WakeTime(data.wakeTime || "07:30");
                setR90Options(data.options || []);
                if (data.options && data.options.find((o) => o.cycles === 5)) setR90TargetCycles(5);
              }
              const ovRes = await fetch(apiUrl("schedule/r90/overview"), { headers: { Authorization: "Bearer " + token } });
              const ov = await ovRes.json();
              if (!ov.error) setR90Overview(ov);
            } catch (e) {}
          }
          fetchR90();
        }, [token, view]);

        React.useEffect(() => {
          if (view !== "motivation") return;
          async function fetchMotivation() {
            try {
              const q = motivationTab === "mine" ? "?filter=mine" : (motivationTab === "milestone" ? "?filter=milestone" : "");
              const res = await fetch(apiUrl("motivation/posts" + q), { headers: { Authorization: "Bearer " + token } });
              const data = await res.json();
              if (!data.error && data.posts) setMotivationPosts(data.posts || []);
              if (motivationTab === "capsule") {
                const capRes = await fetch(apiUrl("time-capsules"), { headers: { Authorization: "Bearer " + token } });
                const capData = await capRes.json();
                if (!capData.error && capData.capsules) setCapsules(capData.capsules || []);
              }
            } catch (e) {}
          }
          fetchMotivation();
        }, [token, view, motivationTab]);

        React.useEffect(() => {
          if (view !== "shop") return;
          async function fetchShop() {
            try {
              const [itemsRes, wishRes] = await Promise.all([
                fetch(apiUrl("reward-items")),
                fetch(apiUrl("wish-rewards"), { headers: { Authorization: "Bearer " + token } }),
              ]);
              const itemsData = await itemsRes.json();
              if (!itemsData.error && itemsData.rewardItems) setShopItems(itemsData.rewardItems || []);
              const wishData = await wishRes.json();
              if (!wishData.error && wishData.wishes) setWishList(wishData.wishes || []);
            } catch (e) {}
          }
          fetchShop();
        }, [token, view]);

        React.useEffect(() => {
          if (!showQuickRetro) return;
          async function fetchTemplatesForModal() {
            try {
              const tRes = await fetch(apiUrl("retrospect-templates"), { headers: { Authorization: "Bearer " + token } });
              const tData = await tRes.json();
              if (!tData.error) {
                setTplMine(tData.mine || []);
                setTplSystem(tData.system || []);
                const last = window.localStorage.getItem("lastTemplateId");
                const fallbackId = last ? Number(last) : ((tData.mine && tData.mine[0] && tData.mine[0].id) || (tData.system && tData.system[0] && tData.system[0].id) || 1);
                if (!selectedTemplateId) setSelectedTemplateId(fallbackId);
              }
            } catch (e) {}
          }
          fetchTemplatesForModal();
        }, [token, showQuickRetro]);

        const safeUser = home && home.user ? home.user : {};
        const safeExp = home && home.experience ? home.experience : {};
        const safeRewards =
          home && home.rewardsSummary ? home.rewardsSummary : {};
        const safeAttrs =
          home && home.attributes ? home.attributes : null;

        const level =
          typeof safeUser.level === "number" && safeUser.level > 0
            ? safeUser.level
            : 1;
        const expPercent =
          typeof safeExp.percent === "number" ? safeExp.percent : 0;
        const cash =
          typeof safeUser.cash_balance === "number"
            ? safeUser.cash_balance
            : 0;
        const coins =
          typeof safeRewards.coins === "number" ? safeRewards.coins : 0;

        return (
          <div>
            {view !== "main" && (
              <div className="view-back">
                <button className="btn btn-outline" onClick={() => setView("main")}>â† è¿”å›å¤§å…</button>
              </div>
            )}
            {view === "main" && (
            <React.Fragment>
            <div className="status-bar">
              <div className="user-info">
                <div className="avatar">
                  {(safeUser.username || user.username || "ç©")[0]}
                </div>
                <div className="user-meta">
                  <span className="user-meta-name">
                    {safeUser.username || user.username}
                  </span>
                  <div className="level-wrap">
                    <span className="level-badge">Lv.{level}</span>
                    <div className="exp-bar">
                      <div
                        className="exp-fill"
                        style={{ width: `${expPercent}%` }}
                      />
                    </div>
                    <span className="exp-label">{expPercent}%</span>
                  </div>
                </div>
              </div>
              <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
                <div className="status-amount">
                  <div className="status-amount-main">Â¥ {cash.toFixed(2)}</div>
                  <div className="status-amount-sub">å½“å‰ä½™é¢ Â· é‡‘å¸ {coins}</div>
                </div>
                <button
                  className="notif-bell"
                  onClick={() => setShowNotifications(!showNotifications)}
                  title="æŸ¥çœ‹é€šçŸ¥"
                >
                  ğŸ””
                  {notifications.filter((n) => !n.read).length > 0 && (
                    <span className="notif-dot">
                      {Math.min(
                        99,
                        notifications.filter((n) => !n.read).length
                      )}
                    </span>
                  )}
                </button>
              </div>
            </div>
            {showNotifications && (
              <div className="notif-list">
                {notifications.length === 0 ? (
                  <div>æš‚æ— é€šçŸ¥</div>
                ) : (
                  notifications.map((n, idx) => (
                    <div
                      key={n.id || idx}
                      className="notif-item"
                    >
                      <span className="notif-item-title">
                        {n.title || "é€šçŸ¥"}
                      </span>
                      <span>{n.content || n.message}</span>
                    </div>
                  ))
                )}
              </div>
            )}
            {error && (
              <div
                style={{
                  marginBottom: 10,
                  fontSize: 12,
                  color: "#d64545",
                }}
              >
                {error}
              </div>
            )}
            <div className="dashboard">
              <AttributePanel attributes={safeAttrs} />

              <div className="modules">
                <div className="card">
                  <h3>ğŸ—ºï¸ ä¸»çº¿ä»»åŠ¡</h3>
                  {!home && (
                    <p style={{ fontSize: 12, color: "#666" }}>åŠ è½½ä¸­...</p>
                  )}
                  {home && (() => {
                    const boss = home.currentBoss || home.mainBoss;
                    const list = home.challengesUnderCurrentBoss || (boss ? (home.challenges || []).filter(function (c) { return c.bossId === boss.id; }) : []) || [];
                    if (!boss) {
                      return <p style={{ fontSize: 12, color: "#666" }}>è¿˜æ²¡æœ‰ Bossï¼Œå…ˆåœ¨ä¸‹æ–¹çš„ã€Œè®¾å®šäººç”Ÿæ°´æ™¶ä¸Bossã€é‡Œåˆ›å»ºä¸€ä¸ªå§ã€‚</p>;
                    }
                    return (
                      <ul style={{ listStyle: "none", padding: 0, margin: 0 }}>
                        <li style={{ marginBottom: 8 }}>
                          <strong>Bossï¼š{boss.title}</strong>
                          <span className="badge" style={{ marginLeft: 6 }}>è¿›è¡Œä¸­</span>
                        </li>
                        {list.length === 0 ? (
                          <li style={{ fontSize: 12, color: "#666" }}>æš‚æ— æŒ‘æˆ˜ï¼Œå¯åœ¨ä¸‹æ–¹æ·»åŠ ã€‚</li>
                        ) : (
                          list.map(function (c) {
                            return (
                              <li key={c.id} className="challenge-link" onClick={() => openChallengeDetail(c.id)}>
                                {loadingChallengeId === c.id ? "åŠ è½½ä¸­â€¦" : "ğŸ“Œ " + c.title}
                              </li>
                            );
                          })
                        )}
                      </ul>
                    );
                  })()}
                </div>
                <div className="card">
                  <h3>âš”ï¸ æŠ€èƒ½è£…å¤‡åº“</h3>
                  {!home && (
                    <p style={{ fontSize: 12, color: "#666" }}>åŠ è½½ä¸­...</p>
                  )}
                  {home && (() => {
                    const skillList = home.skills || (plan && plan.skills) || [];
                    if (skillList.length === 0) {
                      return <p style={{ fontSize: 12, color: "#666" }}>è¿˜æ²¡æœ‰æŠ€èƒ½ï¼Œå¯ä»¥åœ¨ä¸‹æ–¹å…ˆæ·»åŠ  1-2 ä¸ªæ ¸å¿ƒæŠ€èƒ½ã€‚</p>;
                    }
                    return (
                      <ul style={{ listStyle: "none", padding: 0, margin: 0 }}>
                        {skillList.map(function (s) {
                          return (
                            <li key={s.id} style={{ padding: "4px 0", borderBottom: "1px solid #eee" }}>
                              {s.name} <span className="badge">Lv.{s.level || 1}</span>
                            </li>
                          );
                        })}
                      </ul>
                    );
                  })()}
                </div>
                <div className="card">
                  <h3>ğŸ“Š æ—¥å¸¸ä»»åŠ¡</h3>
                  {!home ? (
                    <p style={{ fontSize: 12, color: "#666" }}>åŠ è½½ä¸­...</p>
                  ) : (home.dailyTasks && home.dailyTasks.length > 0) ? (
                    <ul style={{ listStyle: "none", padding: 0, margin: 0 }}>
                      {home.dailyTasks.map(function (t) {
                        const isDone = t.status === "completed";
                        const isCompleting = completingTaskId === t.id;
                        return (
                          <li key={t.id} className={"task-row " + (isDone ? "done" : "") + (isCompleting ? " completing" : "")}>
                            <span className="task-title">{isDone ? "âœ… " : "â³ "}{t.title}</span>
                            {!isDone && (
                              <button
                                className="btn-complete"
                                disabled={!!completingTaskId}
                                onClick={async function () {
                                  setCompletingTaskId(t.id);
                                  try {
                                    const res = await fetch(apiUrl("tasks/" + t.id + "/complete"), {
                                      method: "POST",
                                      headers: { Authorization: "Bearer " + token },
                                    });
                                    const data = await res.json();
                                    if (data.success) {
                                      setFeedbackData(data);
                                      setHome(function (prev) {
                                        if (!prev) return prev;
                                        const u = data.user || {};
                                        const next = { ...prev };
                                        if (prev.dailyTasks) {
                                          next.dailyTasks = prev.dailyTasks.map(function (tt) {
                                            return tt.id === data.task.id ? { ...tt, status: "completed", completedAt: data.task.completedAt } : tt;
                                          });
                                        }
                                        if (u.level != null) next.user = { ...prev.user, ...u };
                                        if (u.attributes) next.attributes = u.attributes;
                                        if (u.coins != null && prev.rewardsSummary) next.rewardsSummary = { ...prev.rewardsSummary, coins: u.coins };
                                        if (u.total_xp != null && u.level != null && prev.experience) {
                                          next.experience = { ...prev.experience, current: u.total_xp, nextLevel: u.level * 100, percent: Math.min(100, Math.floor((u.total_xp / (u.level * 100)) * 100)) };
                                        }
                                        return next;
                                      });
                                      // ç®€å•æ™ºèƒ½æ¨èç¤ºä¾‹ï¼šæ£€æµ‹â€œå¥èº«/è¿åŠ¨â€ç±»ä»»åŠ¡ï¼Œæ¨èåˆ›å»ºä¸“å±è¡¥ç»™åŒ…
                                      if (/å¥èº«|è¿åŠ¨/.test(t.title || "")) {
                                        try {
                                          const ok = window.confirm("æ£€æµ‹åˆ°ä½ å®Œæˆäº†å¥èº«ç›¸å…³ä»»åŠ¡ï¼Œè¦ä¸ºä½ åˆ›å»ºä¸€ä¸ªã€Œå¥èº«èˆ’å‹ã€è¡¥ç»™åŒ…å—ï¼Ÿ");
                                          if (ok) {
                                            const res2 = await fetch(apiUrl("supply-packs/custom"), {
                                              method: "POST",
                                              headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
                                              body: JSON.stringify({
                                                scenario: "exercise",
                                                name: "å¥èº«èˆ’å‹",
                                                description: "æ¯æ¬¡å®Œæˆå¥èº«ä»»åŠ¡åï¼Œç»™è‡ªå·±ä¸€ç‚¹å¥–åŠ±ä¸æ”¾æ¾ã€‚",
                                                effects: { water: 10, fire: 4, earth: 0, wood: 2, metal: 0 },
                                                cooldownMinutes: 30,
                                              }),
                                            });
                                            const d2 = await res2.json();
                                            if (d2 && d2.success) {
                                              window.alert("å·²ä¸ºä½ åˆ›å»ºã€Œå¥èº«èˆ’å‹ã€è¡¥ç»™åŒ…ï¼Œå¹¶å‘æ”¾ 1 ä»½åˆ°èƒŒåŒ…ã€‚ä¸‹æ¬¡å¥èº«å®Œæˆåå¯ä»¥è¯•è¯•ã€‚");
                                              refreshHome();
                                            }
                                          }
                                        } catch (e2) {}
                                      }
                                    } else {
                                      alert(data.error || "å®Œæˆå¤±è´¥");
                                    }
                                  } catch (e) {
                                    alert("è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¡®è®¤åç«¯å·²è¿è¡Œ");
                                  } finally {
                                    setCompletingTaskId(null);
                                  }
                                }}
                              >
                                å®Œæˆ
                              </button>
                            )}
                          </li>
                        );
                      })}
                    </ul>
                  ) : (
                    <p style={{ fontSize: 12, color: "#666" }}>æš‚æ— ä»»åŠ¡ï¼Œå®Œæˆä¸»çº¿æˆ–åˆ·æ–°åä¼šè‡ªåŠ¨ç”Ÿæˆé»˜è®¤ä»»åŠ¡ã€‚</p>
                  )}
                </div>
                <div className="card">
                  <h3>ğŸ å¥–åŠ±ä»“åº“</h3>
                  <ul>
                    <li>é‡‘å¸ï¼š{coins}</li>
                    <li>å¾½ç« ï¼šè¿ç»­å­¦ä¹  7 å¤©</li>
                    <li>ç§°å·ï¼šæ—©é¸Ÿ</li>
                  </ul>
                </div>
                <div className="card">
                  <h3>ğŸ’ è¡¥ç»™åŒ…ä»“åº“</h3>
                  <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 6 }}>
                    <p style={{ fontSize: 12, color: "#666", margin: 0 }}>æŠŠè¡¥ç»™åŒ…åšæˆâ€œæƒ…æ™¯é…æ–¹â€ï¼Œä¸ºä¸åŒæ—¶åˆ»å‡†å¤‡å°ç¡®å¹¸ã€‚</p>
                    <button
                      className="btn btn-outline"
                      style={{ fontSize: 12, padding: "6px 10px" }}
                      onClick={() => {
                        setSupplyForm({
                          scenario: "",
                          name: "",
                          description: "",
                          effects: { wood: 0, fire: 0, earth: 0, metal: 0, water: 0 },
                          cooldownMinutes: 0,
                        });
                        setShowSupplyModal(true);
                      }}
                    >
                      âš¡ å¿«é€Ÿåˆ›å»ºæƒ…æ™¯è¡¥ç»™åŒ…
                    </button>
                  </div>
                  {!home ? (
                    <p style={{ fontSize: 12, color: "#666" }}>åŠ è½½ä¸­...</p>
                  ) : (home.userSupplies && home.userSupplies.length > 0) ? (
                    <ul style={{ listStyle: "none", padding: 0, margin: 0 }}>
                      {home.userSupplies.map(function (us) {
                        const pack = us.pack || {};
                        const isUsing = usingSupplyId === us.id;
                        return (
                          <li key={us.id} className="supply-item">
                            <span>{pack.icon || "ğŸ“¦"} {pack.name || "è¡¥ç»™"} Ã—{us.quantity || 0}</span>
                            <div style={{ display: "flex", gap: 8 }}>
                              <button
                                className="supply-use-btn"
                                disabled={isUsing || (us.quantity || 0) < 1}
                                onClick={async function () {
                                  setUsingSupplyId(us.id);
                                  try {
                                    const res = await fetch(apiUrl("user-supplies/" + us.id + "/use"), {
                                      method: "POST",
                                      headers: { Authorization: "Bearer " + token },
                                    });
                                    const data = await res.json();
                                    if (res.status === 429) {
                                      alert(data.error || "å†·å´ä¸­");
                                    } else if (data.success) {
                                      if (data.elementInteractions && data.elementInteractions.length > 0) {
                                        alert("ä½¿ç”¨æˆåŠŸï¼\n" + data.elementInteractions.join("\n"));
                                      }
                                      refreshHome();
                                    } else {
                                      alert(data.error || "ä½¿ç”¨å¤±è´¥");
                                    }
                                  } catch (e) {
                                    alert("è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¡®è®¤åç«¯å·²è¿è¡Œ");
                                  } finally {
                                    setUsingSupplyId(null);
                                  }
                                }}
                              >
                                {isUsing ? "ä½¿ç”¨ä¸­â€¦" : "ä½¿ç”¨"}
                              </button>
                              <button
                                className="btn btn-outline"
                                style={{ fontSize: 11, padding: "4px 8px" }}
                                onClick={() => {
                                  setSupplyForm({
                                    scenario: pack.scenario || "",
                                    name: (pack.name || "æ–°è¡¥ç»™") + " Â· æˆ‘çš„ç‰ˆ",
                                    description: pack.description || "",
                                    effects: {
                                      wood: (pack.effects && pack.effects.wood) || 0,
                                      fire: (pack.effects && pack.effects.fire) || 0,
                                      earth: (pack.effects && pack.effects.earth) || 0,
                                      metal: (pack.effects && pack.effects.metal) || 0,
                                      water: (pack.effects && pack.effects.water) || 0,
                                    },
                                    cooldownMinutes: pack.cooldownMinutes || 0,
                                  });
                                  setShowSupplyModal(true);
                                }}
                              >
                                ä»¥æ­¤ä¸ºåŸºç¡€åˆ›å»º
                              </button>
                            </div>
                          </li>
                        );
                      })}
                    </ul>
                  ) : (
                    <p style={{ fontSize: 12, color: "#666" }}>æš‚æ— è¡¥ç»™åŒ…ï¼Œå®Œæˆä»»åŠ¡æˆ–åˆ·æ–°åå¯è·å¾—é»˜è®¤è¡¥ç»™ã€‚</p>
                  )}
                </div>

                {/* é‡Œç¨‹ç¢‘ 2ï¼šç®€å•çš„ç›®æ ‡ä¸æŒ‘æˆ˜åˆ›å»ºå ä½ */}
                <div className="card" style={{ gridColumn: "1 / span 2" }}>
                  <h3>ğŸ¯ è®¾å®šäººç”Ÿæ°´æ™¶ä¸ Bossï¼ˆé‡Œç¨‹ç¢‘ 2ï¼‰</h3>
                  <p style={{ fontSize: 12, color: "#666", marginBottom: 6 }}>
                    è¿™é‡Œå…ˆæä¾›ä¸€ä¸ªéå¸¸ç®€åŒ–çš„å…¥å£ï¼šå¯ä»¥å¡«å†™ä¸€å¥è¯ã€Œäººç”Ÿæ°´æ™¶ã€ã€ä¸€ä¸ªé˜¶æ®µ Boss æ ‡é¢˜ï¼Œä»¥åŠä¸€ä¸ªæŒ‘æˆ˜æ ‡é¢˜å’Œæ‰€éœ€æŠ€èƒ½æ ‡ç­¾ã€‚
                  </p>
                  <div className="form-group" style={{ marginTop: 4 }}>
                    <label>äººç”Ÿæ°´æ™¶ï¼ˆä¸€å¥è¯æ„¿æ™¯ï¼‰</label>
                    <input
                      id="vision-input"
                      placeholder="ä¾‹å¦‚ï¼šæˆä¸ºç‹¬ç«‹çš„æ•°å­—æ¸¸æ°‘"
                    />
                  </div>
                  <div className="form-group">
                    <label>Boss æ ‡é¢˜</label>
                    <input
                      id="boss-input"
                      placeholder="ä¾‹å¦‚ï¼šè·å¾— Python é«˜çº§å·¥ç¨‹å¸ˆ Offer"
                    />
                  </div>
                  <div className="form-group">
                    <label>æŒ‘æˆ˜æ ‡é¢˜</label>
                    <input
                      id="challenge-input"
                      placeholder="ä¾‹å¦‚ï¼šå®Œæˆä¸€ä¸ªåç«¯é¡¹ç›®"
                    />
                  </div>
                  <div className="form-group">
                    <label>æŒ‘æˆ˜æ ¸å¿ƒæŠ€èƒ½ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰</label>
                    <input
                      id="challenge-skills-input"
                      placeholder="ä¾‹å¦‚ï¼šPython,Django,æ•°æ®åº“è®¾è®¡"
                    />
                  </div>
                  <button
                    className="btn btn-primary"
                    style={{ marginTop: 4 }}
                    onClick={async function () {
                      var visionEl = document.getElementById("vision-input");
                      var bossEl = document.getElementById("boss-input");
                      var chEl = document.getElementById("challenge-input");
                      var skillsEl = document.getElementById(
                        "challenge-skills-input"
                      );
                      if (!visionEl || !bossEl || !chEl || !skillsEl) {
                        return;
                      }
                      var visionText = visionEl.value;
                      var bossText = bossEl.value;
                      var chText = chEl.value;
                      var skillsText = skillsEl.value;
                      if (!visionText || !bossText || !chText) {
                        alert("è¯·å…ˆå¡«å†™æ°´æ™¶ã€Boss å’ŒæŒ‘æˆ˜æ ‡é¢˜");
                        return;
                      }
                      try {
                        // åˆ›å»ºæˆ–æ›´æ–°äººç”Ÿæ°´æ™¶
                        var resVision = await fetch(
                          apiUrl("visions"),
                          {
                            method: "POST",
                            headers: {
                              "Content-Type": "application/json",
                              Authorization: "Bearer " + token,
                            },
                            body: JSON.stringify({ content: visionText }),
                          }
                        );
                        var v = await resVision.json();
                        if (v.error) {
                          alert("ä¿å­˜äººç”Ÿæ°´æ™¶å¤±è´¥ï¼š" + v.error);
                          return;
                        }
                        // åˆ›å»º Boss
                        var resBoss = await fetch(
                          apiUrl("bosses"),
                          {
                            method: "POST",
                            headers: {
                              "Content-Type": "application/json",
                              Authorization: "Bearer " + token,
                            },
                            body: JSON.stringify({
                              visionId: v.id,
                              title: bossText,
                            }),
                          }
                        );
                        var b = await resBoss.json();
                        if (b.error) {
                          alert("åˆ›å»º Boss å¤±è´¥ï¼š" + b.error);
                          return;
                        }
                        // ç®€å•è§£ææŠ€èƒ½åç§°æ•°ç»„ï¼Œè‹¥ä¸å­˜åœ¨åˆ™ä¾æ¬¡åˆ›å»ºæŠ€èƒ½
                        var names = skillsText
                          ? skillsText.split(",").map(function (s) {
                              return s.trim();
                            })
                          : [];
                        var coreSkills = [];
                        for (var i = 0; i < names.length; i++) {
                          if (!names[i]) continue;
                          coreSkills.push(names[i]);
                          // æŸ¥æ‰¾æ˜¯å¦å·²æœ‰åŒåæŠ€èƒ½
                          if (plan && plan.skills) {
                            var exists = plan.skills.find(function (s) {
                              return s.name === names[i];
                            });
                            if (exists) continue;
                          }
                          await fetch(apiUrl("skills"), {
                            method: "POST",
                            headers: {
                              "Content-Type": "application/json",
                              Authorization: "Bearer " + token,
                            },
                            body: JSON.stringify({
                              name: names[i],
                            }),
                          });
                        }
                        // åˆ›å»ºæŒ‘æˆ˜ï¼ˆå…³è” Boss ä¸æŠ€èƒ½æ ‡ç­¾ï¼‰
                        await fetch(apiUrl("challenges"), {
                          method: "POST",
                          headers: {
                            "Content-Type": "application/json",
                            Authorization: "Bearer " + token,
                          },
                          body: JSON.stringify({
                            bossId: b.id,
                            title: chText,
                            coreSkills: coreSkills,
                            skillLevelRequirements: coreSkills.reduce(function (o, n) { o[n] = 1; return o; }, {}),
                          }),
                        });
                        alert("å·²ä¿å­˜äººç”Ÿæ°´æ™¶ / Boss / æŒ‘æˆ˜ï¼ˆé‡Œç¨‹ç¢‘ 2 ç®€åŒ–ç‰ˆï¼‰");
                        refreshHome();
                        try {
                          var resOverview = await fetch(
                            apiUrl("plan/overview"),
                            { headers: { Authorization: "Bearer " + token } }
                          );
                          var dataOverview = await resOverview.json();
                          if (!dataOverview.error) setPlan(dataOverview);
                        } catch (e) {}
                      } catch (e) {
                        alert("ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æ˜¯å¦è¿è¡Œï¼š" + e);
                      }
                    }}
                  >
                    ä¿å­˜ç›®æ ‡ä¸æŒ‘æˆ˜ï¼ˆM2ï¼‰
                  </button>
                </div>
              </div>

              <div className="sidebar">
                <div className="nav-card">
                  <h3>å¯¼èˆª</h3>
                  <ul className="nav-list">
                    <li onClick={() => setView("schedule")} style={{ cursor: "pointer" }}>ğŸ½ï¸ é¥®é£Ÿä½œæ¯</li>
                    <li onClick={() => setView("plan")} style={{ cursor: "pointer" }}>ğŸ“ è®¡åˆ’åˆ¶å®š</li>
                    <li onClick={() => setView("finance")} style={{ cursor: "pointer" }}>ğŸ’° è´¢åŠ¡ç®¡ç†</li>
                    <li onClick={() => setView("sideQuests")} style={{ cursor: "pointer" }}>ğŸŒ± æ”¯çº¿ä»»åŠ¡</li>
                    <li onClick={() => setView("entertainment")} style={{ cursor: "pointer" }}>ğŸ® å¨±ä¹è®°å½•</li>
                    <li onClick={() => setView("retrospect")} style={{ cursor: "pointer" }}>ğŸ§  å¤ç›˜</li>
                    <li>ğŸ‘¥ ç¤¾äº¤ï¼ˆå¥½å‹/å…¬ä¼šï¼‰</li>
                    <li onClick={() => setView("shop")} style={{ cursor: "pointer" }}>ğŸª å¥–åŠ±å•†åŸ</li>
                    <li onClick={() => setView("motivation")} style={{ cursor: "pointer" }}>ğŸ’¬ åŠ±å¿—å¢™</li>
                    <li>âš™ï¸ è®¾ç½®</li>
                  </ul>
                </div>
                <div className="card">
                  <h3>ğŸ‘¥ å¥½å‹åŠ¨æ€</h3>
                  {friendFeedLoading && <div style={{ fontSize: 12, color: "#666" }}>æ­£åœ¨è½½å…¥åŒé“çš„è„šæ­¥...</div>}
                  {!friendFeedLoading && friendFeedError && (
                    <div style={{ fontSize: 12, color: "#c62828" }}>{friendFeedError}</div>
                  )}
                  {!friendFeedLoading && !friendFeedError && friendFeed.length === 0 && (
                    <div style={{ fontSize: 12, color: "#666" }}>è¿˜æ²¡æœ‰å¥½å‹åŠ¨æ€ï¼Œå¯ä»¥å…ˆæ·»åŠ å‡ ä½åŒè·¯äººã€‚</div>
                  )}
                  {!friendFeedLoading && !friendFeedError && friendFeed.length > 0 && (
                    <ul className="nav-list" style={{ marginTop: 6 }}>
                      {friendFeed.slice(0, 6).map(function (item, idx) {
                        var u = item.user || {};
                        var name = u.username || "å¥½å‹";
                        var title = item.title || "";
                        var content = item.content || "";
                        return (
                          <li key={idx} style={{ fontSize: 12, lineHeight: 1.5, borderBottom: "1px solid #eee", padding: "6px 0" }}>
                            <div style={{ fontWeight: 600 }}>
                              {name}
                              {item.type === "notification" && <span style={{ marginLeft: 4, fontSize: 11, color: "#888" }}>Â· æˆå°±</span>}
                              {item.type === "motivation" && <span style={{ marginLeft: 4, fontSize: 11, color: "#888" }}>Â· åŠ±å¿—ç¬é—´</span>}
                            </div>
                            {title && <div style={{ fontSize: 12 }}>{title}</div>}
                            {content && (
                              <div style={{ fontSize: 12, color: "#555", marginTop: 2, maxHeight: 40, overflow: "hidden", textOverflow: "ellipsis" }}>
                                {content}
                              </div>
                            )}
                          </li>
                        );
                      })}
                    </ul>
                  )}
                </div>
              </div>
            </div>
            </React.Fragment>
            )}

            {view === "plan" && (
              <div className="finance-page">
                <h3 style={{ marginBottom: 8, fontSize: 18 }}>ğŸ“ æˆ˜ç•¥æ²™ç›˜ Â· è®¡åˆ’åˆ¶å®š</h3>
                <p style={{ fontSize: 12, color: "#666", marginBottom: 10 }}>
                  åœ¨è¿™é‡Œç”¨â€œç›®æ ‡ â†’ æˆ˜å½¹ â†’ ä»»åŠ¡â€çš„æ ‘çŠ¶ç»“æ„æ‹†è§£ä½ çš„é•¿æœŸè§„åˆ’ï¼Œå¹¶å°†ä»»åŠ¡æ´¾å¾€ä¸»çº¿æˆ˜åœºã€‚
                </p>
                <div style={{ display: "flex", gap: 8, marginBottom: 10 }}>
                  <button className={"btn " + (planView === "list" ? "btn-primary" : "btn-outline")} onClick={() => setPlanView("list")}>æˆ˜ç•¥è§†å›¾</button>
                  <button className={"btn " + (planView === "progress" ? "btn-primary" : "btn-outline")} onClick={() => setPlanView("progress")}>è¿›åº¦è§†å›¾</button>
                </div>

                {planView === "list" && (
                  <div className="finance-card">
                    <div style={{ display: "flex", justifyContent: "space-between", marginBottom: 8 }}>
                      <h4 style={{ marginBottom: 0 }}>ğŸ¯ æˆ˜ç•¥æ¸…å•</h4>
                      <button
                        className="btn btn-outline"
                        onClick={async () => {
                          const title = window.prompt("æ–°ç›®æ ‡åç§°", "æˆä¸ºæ›´å¼ºçš„è‡ªå·±");
                          if (!title) return;
                          try {
                            const res = await fetch(apiUrl("strategic-nodes"), {
                              method: "POST",
                              headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
                              body: JSON.stringify({ type: "goal", title }),
                            });
                            const data = await res.json();
                            if (!data.success) { window.alert(data.error || "åˆ›å»ºå¤±è´¥"); return; }
                            setStrategicNodes([...(strategicNodes || []), data.node]);
                          } catch (e) { window.alert("åˆ›å»ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æ˜¯å¦è¿è¡Œ"); }
                        }}
                      >
                        ï¼‹ æ·»åŠ ç›®æ ‡
                      </button>
                    </div>
                    {planError && <p style={{ fontSize: 12, color: "#b91c1c" }}>{planError}</p>}
                    <div style={{ fontSize: 13 }}>
                      {(() => {
                        const byParent = {};
                        (strategicNodes || []).forEach(function (n) {
                          const key = n.parentId || "root";
                          if (!byParent[key]) byParent[key] = [];
                          byParent[key].push(n);
                        });
                        Object.keys(byParent).forEach(function (k) {
                          byParent[k].sort(function (a, b) { return new Date(a.createdAt) - new Date(b.createdAt); });
                        });
                        function renderNodes(parentId, depth) {
                          const list = byParent[parentId || "root"] || [];
                          return list.map(function (n) {
                            const indent = { paddingLeft: depth * 16 };
                            const tag = n.type === "goal" ? "ğŸ¯" : (n.type === "campaign" ? "ğŸ–" : "âœ…");
                            const statusLabel = n.status === "active" ? "è¿›è¡Œä¸­" : (n.status === "completed" ? "å·²å®Œæˆ" : "è§„åˆ’ä¸­");
                            const hasChildren = !!(byParent[n.id] && byParent[n.id].length);
                            return (
                              <div key={n.id}>
                                <div style={{ display: "flex", alignItems: "center", gap: 8, margin: "4px 0" }}>
                                  <div style={indent}>
                                    <span>{tag}</span>
                                  </div>
                                  <input
                                    value={n.title}
                                    onChange={async (e) => {
                                      const title = e.target.value;
                                      setStrategicNodes((strategicNodes || []).map(function (x) { return x.id === n.id ? { ...x, title } : x; }));
                                      try {
                                        await fetch(apiUrl("strategic-nodes/" + n.id), {
                                          method: "PATCH",
                                          headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
                                          body: JSON.stringify({ title }),
                                        });
                                      } catch (e2) {}
                                    }}
                                    style={{ flex: 1, minWidth: 160, padding: "6px 8px", borderRadius: 8, border: "1px solid #ddd", fontSize: 13 }}
                                  />
                                  <select
                                    value={n.status || "planning"}
                                    onChange={async (e) => {
                                      const status = e.target.value;
                                      setStrategicNodes((strategicNodes || []).map(function (x) { return x.id === n.id ? { ...x, status } : x; }));
                                      try {
                                        await fetch(apiUrl("strategic-nodes/" + n.id), {
                                          method: "PATCH",
                                          headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
                                          body: JSON.stringify({ status }),
                                        });
                                      } catch (e2) {}
                                    }}
                                    style={{ padding: "6px 8px", borderRadius: 8, border: "1px solid #ddd", fontSize: 12 }}
                                  >
                                    <option value="planning">è§„åˆ’ä¸­</option>
                                    <option value="active">è¿›è¡Œä¸­</option>
                                    <option value="paused">å·²æš‚åœ</option>
                                    <option value="completed">å·²å®Œæˆ</option>
                                  </select>
                                  {n.type !== "task" && (
                                    <button
                                      className="btn btn-outline"
                                      style={{ fontSize: 11, padding: "4px 8px" }}
                                      onClick={async () => {
                                        const type = window.prompt("æ·»åŠ å­èŠ‚ç‚¹ç±»å‹ï¼šgoal/campaign/task", "task");
                                        const title = window.prompt("å­èŠ‚ç‚¹æ ‡é¢˜", "æ–°çš„ä»»åŠ¡");
                                        if (!type || !title) return;
                                        try {
                                          const res = await fetch(apiUrl("strategic-nodes"), {
                                            method: "POST",
                                            headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
                                            body: JSON.stringify({ parentId: n.id, type, title }),
                                          });
                                          const data = await res.json();
                                          if (!data.success) { window.alert(data.error || "åˆ›å»ºå¤±è´¥"); return; }
                                          setStrategicNodes([...(strategicNodes || []), data.node]);
                                        } catch (e2) { window.alert("åˆ›å»ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æ˜¯å¦è¿è¡Œ"); }
                                      }}
                                    >
                                      ï¼‹ å­èŠ‚ç‚¹
                                    </button>
                                  )}
                                  {n.type === "task" && (
                                    <button
                                      className="btn btn-outline"
                                      style={{ fontSize: 11, padding: "4px 8px" }}
                                      onClick={async () => {
                                        try {
                                          const attrs = n.attributes || {};
                                          if (attrs.linkedTaskId) {
                                            window.alert("å·²æ´¾å¾€ä¸»çº¿ï¼Œå¯¹åº”ä»»åŠ¡IDï¼š" + attrs.linkedTaskId);
                                            return;
                                          }
                                          const res = await fetch(apiUrl("tasks"), {
                                            method: "POST",
                                            headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
                                            body: JSON.stringify({ title: n.title, type: "main", xpReward: 20, coinsReward: 10 }),
                                          });
                                          const data = await res.json();
                                          if (data.error) { window.alert(data.error || "åˆ›å»ºä»»åŠ¡å¤±è´¥"); return; }
                                          const linkedTaskId = data.id || data.taskId || data.task && data.task.id;
                                          if (!linkedTaskId) { window.alert("ä»»åŠ¡å·²åˆ›å»ºï¼Œä½†æœªè¿”å›ID"); return; }
                                          await fetch(apiUrl("strategic-nodes/" + n.id), {
                                            method: "PATCH",
                                            headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
                                            body: JSON.stringify({ attributes: { linkedTaskId } }),
                                          });
                                          setStrategicNodes((strategicNodes || []).map(function (x) { return x.id === n.id ? { ...x, attributes: { ...(x.attributes || {}), linkedTaskId } } : x; }));
                                          refreshHome();
                                          window.alert("å·²æ´¾å¾€ä¸»çº¿ä»»åŠ¡åŒº");
                                        } catch (e2) { window.alert("æ“ä½œå¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æ˜¯å¦è¿è¡Œ"); }
                                      }}
                                    >
                                      æ´¾å¾€ä¸»çº¿
                                    </button>
                                  )}
                                  <button
                                    className="btn btn-outline"
                                    style={{ fontSize: 11, padding: "4px 8px" }}
                                    onClick={async () => {
                                      if (!window.confirm("ç¡®å®šåˆ é™¤è¯¥èŠ‚ç‚¹å—ï¼Ÿå…¶å­èŠ‚ç‚¹ä¹Ÿä¼šä¸€å¹¶åˆ é™¤ã€‚")) return;
                                      try {
                                        const res = await fetch(apiUrl("strategic-nodes/" + n.id), {
                                          method: "DELETE",
                                          headers: { Authorization: "Bearer " + token },
                                        });
                                        const data = await res.json();
                                        if (!data.success) { window.alert(data.error || "åˆ é™¤å¤±è´¥"); return; }
                                        setStrategicNodes((strategicNodes || []).filter(function (x) { return x.id !== n.id; }));
                                      } catch (e2) { window.alert("åˆ é™¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æ˜¯å¦è¿è¡Œ"); }
                                    }}
                                  >
                                    åˆ é™¤
                                  </button>
                                </div>
                                {hasChildren && <div>{renderNodes(n.id, depth + 1)}</div>}
                              </div>
                            );
                          });
                        }
                        return <div>{renderNodes(null, 0)}</div>;
                      })()}
                    </div>
                  </div>
                )}

                {planView === "progress" && (
                  <div className="finance-card">
                    <h4>ğŸ“Š æˆ˜ç•¥ç›®æ ‡è¿›åº¦æ¦‚è§ˆï¼ˆç®€ç‰ˆï¼‰</h4>
                    {(() => {
                      const goals = (strategicNodes || []).filter(function (n) { return n.type === "goal"; });
                      if (goals.length === 0) return <p style={{ fontSize: 12, color: "#666" }}>è¿˜æ²¡æœ‰ç›®æ ‡ï¼Œåœ¨â€œæˆ˜ç•¥è§†å›¾â€é‡Œå…ˆæ·»åŠ ä¸€ä¸ªå§ã€‚</p>;
                      const byParent = {};
                      (strategicNodes || []).forEach(function (n) {
                        const key = n.parentId || "root";
                        if (!byParent[key]) byParent[key] = [];
                        byParent[key].push(n);
                      });
                      return goals.map(function (g) {
                        function collectTasks(node) {
                          const children = byParent[node.id] || [];
                          let tasks = [];
                          children.forEach(function (c) {
                            if (c.type === "task") tasks.push(c);
                            tasks = tasks.concat(collectTasks(c));
                          });
                          return tasks;
                        }
                        const tasks = collectTasks(g);
                        const total = tasks.length || 1;
                        const done = tasks.filter(function (t) { return t.status === "completed"; }).length;
                        const pct = Math.floor((done / total) * 100);
                        return (
                          <div key={g.id} style={{ marginBottom: 10 }}>
                            <div style={{ fontSize: 13, marginBottom: 4 }}>{g.title}</div>
                            <div className="progress">
                              <div style={{ width: pct + "%" }} />
                            </div>
                            <div style={{ fontSize: 12, color: "#666", marginTop: 2 }}>
                              å®Œæˆ {done}/{tasks.length} ä¸ªä»»åŠ¡ï¼ˆ{pct}%ï¼‰
                            </div>
                          </div>
                        );
                      });
                    })()}
                  </div>
                )}
              </div>
            )}
            {view === "schedule" && (
              <div className="schedule-page">
                <h3 style={{ marginBottom: 20, fontSize: 18 }}>ğŸŒ™ ç¡çœ é“åœº Â· R90 æ¨¡å¼</h3>

                <div className="finance-card" style={{ marginBottom: 12 }}>
                  <h4>â° å›ºå®šèµ·åºŠæ—¶é—´ï¼ˆé”å®šç”Ÿç‰©é’Ÿï¼‰</h4>
                  <div style={{ display: "flex", gap: 10, alignItems: "center", flexWrap: "wrap" }}>
                    <input value={r90WakeTime} onChange={(e) => setR90WakeTime(e.target.value)} style={{ padding: "10px 12px", borderRadius: 12, border: "1px solid #ccc", width: 110 }} />
                    <button className="btn btn-outline" onClick={async () => {
                      const res = await fetch(apiUrl("schedule/r90/settings"), {
                        method: "POST",
                        headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
                        body: JSON.stringify({ wakeTime: r90WakeTime }),
                      });
                      const data = await res.json();
                      if (data.error) alert(data.error);
                      else {
                        const rec = await fetch(apiUrl("schedule/r90/recommendations"), { headers: { Authorization: "Bearer " + token } });
                        const d = await rec.json();
                        if (!d.error) { setR90WakeTime(d.wakeTime || r90WakeTime); setR90Options(d.options || []); }
                        alert("å·²é”å®šèµ·åºŠæ—¶é—´");
                      }
                    }}>âœ… é”å®š</button>
                    <span style={{ fontSize: 12, color: "#666" }}>å»ºè®®å°½é‡æ¯æ—¥ç›¸åŒ</span>
                  </div>
                </div>

                <div className="finance-card" style={{ marginBottom: 12 }}>
                  <h4>ğŸ“Š æ™ºèƒ½å‘¨æœŸæ¨è</h4>
                  <div style={{ display: "grid", gap: 10 }}>
                    {(r90Options || []).map(function (o) {
                      const bed = new Date(o.bedAt);
                      const bedText = bed.toLocaleTimeString("zh-CN", { hour: "2-digit", minute: "2-digit" });
                      const picked = r90TargetCycles === o.cycles;
                      const tag = o.cycles === 5 ? "â˜… æ¨è" : (o.cycles === 4 ? "æœ€ä½æ¢å¤" : "æ·±åº¦ä¿®å¤");
                      return (
                        <div key={o.cycles} style={{ display: "flex", justifyContent: "space-between", alignItems: "center", padding: "10px 12px", border: "1px solid " + (picked ? "rgba(122,167,255,0.6)" : "rgba(255,255,255,0.25)"), borderRadius: 14, background: picked ? "rgba(243,247,255,0.3)" : "rgba(255,255,255,0.12)" }}>
                          <div>
                            <div style={{ fontWeight: 700 }}>{o.cycles} å‘¨æœŸ <span style={{ fontSize: 12, color: "#666", fontWeight: 500 }}>ï¼ˆéœ€ {bedText} å…¥ç¡ï¼‰</span></div>
                            <div style={{ fontSize: 12, color: "#666" }}>{tag} Â· æ¯å‘¨æœŸâ‰ˆ90åˆ†é’Ÿ + æ½œä¼æœŸ{(o.latencyMin || 15)}åˆ†é’Ÿ</div>
                          </div>
                          <button className={"btn " + (picked ? "btn-primary" : "btn-outline")} onClick={() => setR90TargetCycles(o.cycles)}>{picked ? "å·²é€‰æ‹©" : "é€‰æ‹©"}</button>
                        </div>
                      );
                    })}
                    {(!r90Options || r90Options.length === 0) && <p style={{ color: "#666" }}>åŠ è½½æ¨èä¸­â€¦</p>}
                  </div>
                </div>

                <div className="schedule-buttons" style={{ marginTop: 10 }}>
                  <button className="schedule-btn sleep" disabled={scheduleLogging} onClick={async () => {
                    setScheduleLogging("r90_start");
                    try {
                      const res = await fetch(apiUrl("schedule/r90/start"), {
                        method: "POST",
                        headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
                        body: JSON.stringify({ wakeTime: r90WakeTime, targetCycles: r90TargetCycles }),
                      });
                      const data = await res.json();
                      if (data.error) alert(data.error);
                      else { if (data.rewards && data.rewards.message) alert(data.rewards.message); refreshHome(); }
                    } finally { setScheduleLogging(null); }
                  }}>
                    <span style={{ fontSize: 34 }}>ğŸŒ™</span>
                    å¼€å§‹ä»Šå¤œä¿®è¡Œ
                  </button>
                  <button className="schedule-btn wake" disabled={scheduleLogging} onClick={async () => {
                    setScheduleLogging("r90_wake");
                    try {
                      const res = await fetch(apiUrl("schedule/r90/wake"), {
                        method: "POST",
                        headers: { Authorization: "Bearer " + token },
                      });
                      const data = await res.json();
                      if (data.error) alert(data.error);
                      else {
                        setR90LastReport(data.report || null);
                        refreshHome();
                      }
                    } finally { setScheduleLogging(null); }
                  }}>
                    <span style={{ fontSize: 34 }}>â˜€ï¸</span>
                    é¢†å–å‘¨æœŸç»“ç®—
                  </button>
                </div>

                <div className="schedule-report">
                  <h4>â˜€ï¸ R90 å‘¨æœŸç»“ç®—æŠ¥å‘Š</h4>
                  {r90LastReport ? (
                    <React.Fragment>
                      <p>ç›®æ ‡ï¼š<strong>{r90LastReport.targetCycles}</strong> ä¸ªå‘¨æœŸ ï½œ å®é™…ï¼š<strong>{r90LastReport.cyclesDone}</strong> ä¸ªå‘¨æœŸï¼ˆ{Math.round((r90LastReport.minutes || 0) / 60 * 10) / 10} å°æ—¶ï¼‰</p>
                      <p style={{ color: "#666", fontSize: 12 }}>
                        å…¥ç¡ï¼š{new Date(r90LastReport.sleepStartAt).toLocaleString("zh-CN")} ï½œ é†’æ¥ï¼š{new Date(r90LastReport.wakeAt).toLocaleString("zh-CN")}
                      </p>
                      <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 10, marginTop: 10 }}>
                        <div style={{ padding: 10, border: "1px solid #eee", borderRadius: 12 }}>
                          <div style={{ fontWeight: 700, marginBottom: 6 }}>ğŸ“ˆ å‘¨æœŸè´¨é‡ï¼ˆç®€åŒ–ï¼‰</div>
                          <div style={{ fontSize: 13 }}>æ·±ç¡å‘¨æœŸï¼š{r90LastReport.deepCycles}</div>
                          <div style={{ fontSize: 13 }}>æ ¸å¿ƒç¡çœ ï¼š{r90LastReport.coreCycles}</div>
                          <div style={{ fontSize: 13 }}>REM æ¢¦å¢ƒï¼š{r90LastReport.remCycles}</div>
                        </div>
                        <div style={{ padding: 10, border: "1px solid #eee", borderRadius: 12 }}>
                          <div style={{ fontWeight: 700, marginBottom: 6 }}>âš¡ äº”è¡Œèƒ½é‡è¡¥ç»™</div>
                          <div style={{ fontSize: 13 }}>ğŸŒ³ æœ¨(å¥åº·) +{(r90LastReport.effects && r90LastReport.effects.wood) || 0}</div>
                          <div style={{ fontSize: 13 }}>ğŸ”¥ ç«(ç²¾åŠ›) +{(r90LastReport.effects && r90LastReport.effects.fire) || 0}</div>
                          <div style={{ fontSize: 13 }}>ğŸ’§ æ°´(å¿ƒæƒ…) +{(r90LastReport.effects && r90LastReport.effects.water) || 0}</div>
                        </div>
                      </div>
                      {(r90LastReport.elementInteractions || []).length > 0 && (
                        <div style={{ marginTop: 10, fontSize: 12, color: "#666" }}>
                          {r90LastReport.elementInteractions.map((m, i) => <div key={i}>â€¢ {m}</div>)}
                        </div>
                      )}
                      <div style={{ marginTop: 10, padding: 10, borderRadius: 12, background: "rgba(255,247,237,0.5)", backdropFilter: "blur(8px)", border: "1px solid rgba(254,215,170,0.6)", color: "#9a3412", fontSize: 13 }}>
                        âš ï¸ å»ºè®®ï¼š{r90LastReport.tip}
                      </div>
                    </React.Fragment>
                  ) : (
                    <p style={{ color: "#666" }}>è¿˜æ²¡æœ‰ç»“ç®—æŠ¥å‘Šï¼šå…ˆâ€œå¼€å§‹ä»Šå¤œä¿®è¡Œâ€ï¼Œèµ·åºŠåç‚¹â€œé¢†å–å‘¨æœŸç»“ç®—â€</p>
                  )}
                </div>

                <div className="schedule-report" style={{ marginTop: 16 }}>
                  <h4>ğŸ“Š å‘¨æœŸè¶‹åŠ¿å›¾ï¼ˆæœ€è¿‘ 30 å¤©ï¼‰</h4>
                  {r90Overview && r90Overview.days && r90Overview.days.length > 0 ? (
                    <React.Fragment>
                      <p>å¹³å‡å‘¨æœŸ/å¤œï¼š<strong>{r90Overview.avgCycles}</strong> ï½œ å‘¨æœŸç¨³å®šç‡ï¼ˆâ‰¥90% è¾¾æ ‡ï¼‰ï¼š<strong>{r90Overview.stabilityRate}%</strong>ï¼ˆ{r90Overview.daysCount} å¤©ï¼‰</p>
                      <div className="r90-heat">
                        <div className="r90-heat-grid">
                          {["ä¸€","äºŒ","ä¸‰","å››","äº”","å…­","æ—¥"].map(function (w, i) {
                            return <div key={i} className="r90-heat-cell-label">å‘¨{w}</div>;
                          })}
                          {(() => {
                            const days = r90Overview.days.slice(-28); // æœ€å¤š 4 å‘¨
                            // å¡«å……åˆ° 28 å¤©ï¼Œè¡¥ç©ºæ ¼å­
                            const padded = [];
                            for (let i = 0; i < 28; i++) padded.push(days[days.length - 1 - i] || null);
                            padded.reverse();
                            return padded.map(function (d, idx) {
                              if (!d) return <div key={idx} className="r90-heat-cell" />;
                              const ratio = Math.min(1, d.avgCycles / (d.avgTarget || 5 || 1));
                              const color = `rgba(56,189,248,${0.15 + 0.6 * ratio})`;
                              return (
                                <div
                                  key={idx}
                                  className="r90-heat-cell"
                                  title={`${d.date} Â· ${d.avgCycles} å‘¨æœŸ Â· ç¨³å®šåº¦ ${d.stability}%ï¼ˆç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…ï¼‰`}
                                  style={{ cursor: "pointer" }}
                                  onClick={async () => {
                                    try {
                                      const res = await fetch(apiUrl("schedule/r90/day/" + d.date), { headers: { Authorization: "Bearer " + token } });
                                      const info = await res.json();
                                      if (info.error) alert(info.error);
                                      else setR90DayDetail(info);
                                    } catch (e) { alert("åŠ è½½å½“å¤©è¯¦æƒ…å¤±è´¥"); }
                                  }}
                                >
                                  <div className="r90-heat-cell-inner" style={{ background: color }} />
                                </div>
                              );
                            });
                          })()}
                        </div>
                      </div>
                    </React.Fragment>
                  ) : (
                    <p style={{ color: "#666" }}>æš‚æ— å‘¨æœŸæ•°æ®ï¼šåšæŒå‡ å¤© R90 ç»“ç®—åï¼Œè¿™é‡Œä¼šå‡ºç°ä½ çš„å‘¨æœŸçƒ­åŠ›å›¾å’Œç¨³å®šç‡ã€‚</p>
                  )}
                </div>
              </div>
            )}

            {r90DayDetail && (
              <div className="feedback-overlay" onClick={() => setR90DayDetail(null)}>
                <div className="feedback-modal" onClick={(e) => e.stopPropagation()} style={{ maxWidth: 520, textAlign: "left" }}>
                  <h3>ğŸ“… {r90DayDetail.date} çš„å‘¨æœŸè¯¦æƒ…</h3>
                  <div style={{ fontSize: 12, color: "#666", marginBottom: 8 }}>ç‚¹å‡»ç©ºç™½åŒºåŸŸå…³é—­</div>
                  {(!r90DayDetail.items || r90DayDetail.items.length === 0) && <p style={{ fontSize: 13, color: "#666" }}>è¿™ä¸€å¤©æ²¡æœ‰ R90 ç»“ç®—è®°å½•ã€‚</p>}
                  <ul className="retro-list">
                    {(r90DayDetail.items || []).map(function (it, idx) {
                      return (
                        <li key={idx}>
                          <div style={{ fontWeight: 600, fontSize: 13 }}>ç¬¬ {idx + 1} æ¬¡ç»“ç®—</div>
                          <div style={{ fontSize: 12, color: "#666", marginTop: 2 }}>
                            å…¥ç¡ï¼š{it.sleepStartAt ? new Date(it.sleepStartAt).toLocaleTimeString("zh-CN", { hour: "2-digit", minute: "2-digit" }) : "-"}
                            {" Â· "}é†’æ¥ï¼š{it.wakeAt ? new Date(it.wakeAt).toLocaleTimeString("zh-CN", { hour: "2-digit", minute: "2-digit" }) : "-"}
                          </div>
                          <div style={{ fontSize: 12, marginTop: 4 }}>
                            ç›®æ ‡ {it.targetCycles} å‘¨æœŸ ï½œ å®é™… {it.cyclesDone} å‘¨æœŸï¼ˆæ·±ç¡ {it.deepCycles} Â· REM {it.remCycles}ï¼‰
                          </div>
                          <div style={{ fontSize: 12, marginTop: 4 }}>
                            ğŸŒ³ æœ¨ +{(it.effects && it.effects.wood) || 0} ï½œ ğŸ”¥ ç« +{(it.effects && it.effects.fire) || 0} ï½œ ğŸ’§ æ°´ +{(it.effects && it.effects.water) || 0}
                          </div>
                          {it.tip && <div style={{ fontSize: 12, color: "#9a3412", marginTop: 4 }}>âš ï¸ {it.tip}</div>}
                        </li>
                      );
                    })}
                  </ul>
                </div>
              </div>
            )}

            {view === "sideQuests" && (
              <div className="sidequest-page">
                <h3 style={{ marginBottom: 16, fontSize: 18 }}>ğŸŒ± æ”¯çº¿ä»»åŠ¡</h3>
                <div className="sidequest-add">
                  <input
                    id="sidequest-input"
                    placeholder="è¾“å…¥æ”¯çº¿ç›®æ ‡ï¼Œå¦‚ï¼šçœ‹ä¸€éƒ¨ç”µå½±"
                  />
                  <button
                    className="btn btn-primary"
                    onClick={async () => {
                      const el = document.getElementById("sidequest-input");
                      const title = (el && el.value || "").trim();
                      if (!title) { alert("è¯·è¾“å…¥ç›®æ ‡"); return; }
                      try {
                        const res = await fetch(apiUrl("tasks"), {
                          method: "POST",
                          headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
                          body: JSON.stringify({ title, type: "æ”¯çº¿", xpReward: 8, coinsReward: 3 }),
                        });
                        const data = await res.json();
                        if (data.error) alert(data.error);
                        else { if (el) el.value = ""; setSideQuests([...sideQuests, data]); }
                      } catch (e) { alert("æ·»åŠ å¤±è´¥"); }
                    }}
                  >
                    æ·»åŠ æ”¯çº¿
                  </button>
                </div>
                <div className="sidequest-grid">
                  {sideQuests.length === 0 && <p style={{ color: "#666", gridColumn: "1 / -1" }}>æš‚æ— æ”¯çº¿ï¼Œæ·»åŠ ä¸€ä¸ªè½»æ¾å°ç›®æ ‡å§</p>}
                  {sideQuests.map(function (t) {
                    const isDone = t.status === "completed";
                    return (
                      <div key={t.id} className={"sidequest-card " + (isDone ? "done" : "")}>
                        <div className="sidequest-title">{isDone ? "âœ… " : "ğŸŒ± "}{t.title}</div>
                        {!isDone && (
                          <button
                            className="btn btn-primary"
                            style={{ marginTop: 8, fontSize: 12, padding: "6px 12px" }}
                            onClick={async () => {
                              try {
                                    const res = await fetch(apiUrl("tasks/" + t.id + "/complete"), {
                                  method: "POST",
                                  headers: { Authorization: "Bearer " + token },
                                });
                                const data = await res.json();
                                if (data.success) {
                                  setSideQuests(sideQuests.map(function (q) { return q.id === t.id ? { ...q, status: "completed" } : q; }));
                                  refreshHome();
                                } else alert(data.error);
                              } catch (e) { alert("è¯·æ±‚å¤±è´¥"); }
                            }}
                          >
                            å®Œæˆ
                          </button>
                        )}
                      </div>
                    );
                  })}
                </div>
              </div>
            )}

            {view === "finance" && (
              <div className="finance-page">
                <h3 style={{ marginBottom: 16, fontSize: 18 }}>ğŸ’° è´¢åŠ¡ç®¡ç†</h3>
                {!finance ? (
                  <p style={{ color: "#666" }}>åŠ è½½ä¸­...</p>
                ) : (
                  <React.Fragment>
                    <div className="finance-grid">
                      <div className="finance-card">
                        <h4>ğŸ¦ è´¢å¯ŒBossè¿›åº¦</h4>
                        <div style={{ fontSize: 13, color: "#444", marginBottom: 8 }}>
                          {finance.wealthGoal ? finance.wealthGoal.title : "æœªè®¾ç½®è´¢å¯Œç›®æ ‡ï¼ˆå¯å…ˆç”¨é»˜è®¤ä½™é¢è¿›åº¦ï¼‰"}
                        </div>
                        {finance.wealthGoal && (
                          <React.Fragment>
                            <div className="progress">
                              <div style={{ width: `${Math.min(100, Math.floor(((finance.cash_balance || 0) / finance.wealthGoal.targetAmount) * 100))}%` }} />
                            </div>
                            <div style={{ fontSize: 12, color: "#666", marginTop: 6 }}>
                              å½“å‰ Â¥{(finance.cash_balance || 0).toFixed(2)} / ç›®æ ‡ Â¥{Number(finance.wealthGoal.targetAmount).toFixed(2)}
                            </div>
                          </React.Fragment>
                        )}
                        {!finance.wealthGoal && (
                          <button
                            className="btn btn-outline"
                            style={{ marginTop: 10 }}
                            onClick={async () => {
                              const title = prompt("è´¢å¯Œç›®æ ‡åç§°", "å­˜æ¬¾è¾¾åˆ° 1 ä¸‡");
                              const target = prompt("ç›®æ ‡é‡‘é¢ï¼ˆå…ƒï¼‰", "10000");
                              if (!title || !target) return;
                              const res = await fetch(apiUrl("wealth-goals"), {
                                method: "POST",
                                headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
                                body: JSON.stringify({ title, targetAmount: Number(target) }),
                              });
                              const data = await res.json();
                              if (!data.error) {
                                const fin = await fetch(apiUrl("finance/overview"), { headers: { Authorization: "Bearer " + token } });
                                const finData = await fin.json();
                                if (!finData.error) setFinance(finData);
                              }
                            }}
                          >
                            è®¾ç½®è´¢å¯Œç›®æ ‡
                          </button>
                        )}
                      </div>

                      <div className="finance-card">
                        <h4>ğŸ¯ æœ¬æœˆè‡ªæˆ‘å¥–åŠ±é¢„ç®—</h4>
                        <div style={{ fontSize: 12, color: "#666", marginBottom: 8 }}>
                          æœˆåº¦ï¼š{finance.month} Â· é¢„ç®— Â¥{Number(finance.budget.rewardLimitRmb || 0).toFixed(0)} Â· å·²ç”¨ Â¥{Number(finance.budget.rewardSpentRmb || 0).toFixed(0)}
                        </div>
                        <div className="budget-bar">
                          <div style={{ width: `${Math.min(100, Math.floor(((finance.budget.rewardSpentRmb || 0) / (finance.budget.rewardLimitRmb || 1)) * 100))}%` }} />
                        </div>
                        <div style={{ fontSize: 12, color: "#666", marginTop: 6 }}>
                          å‰©ä½™ Â¥{Math.max(0, Number(finance.budget.rewardLimitRmb || 0) - Number(finance.budget.rewardSpentRmb || 0)).toFixed(0)}
                        </div>
                      </div>

                      <div className="finance-card">
                        <h4>ğŸ§¾ è®°è´¦</h4>
                        <div style={{ display: "flex", gap: 10, flexWrap: "wrap" }}>
                          <select id="tx-type" style={{ padding: "10px 12px", borderRadius: 12, border: "1px solid #ccc" }}>
                            <option value="expense">æ”¯å‡º</option>
                            <option value="income">æ”¶å…¥</option>
                          </select>
                          <input id="tx-amount" placeholder="é‡‘é¢ï¼ˆå…ƒï¼‰" style={{ flex: 1, minWidth: 160 }} />
                          <input id="tx-note" placeholder="å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰" style={{ flex: 1, minWidth: 200 }} />
                          <button
                            className="btn btn-primary"
                            onClick={async () => {
                              const type = document.getElementById("tx-type").value;
                              const amount = Number((document.getElementById("tx-amount").value || "").trim());
                              const note = (document.getElementById("tx-note").value || "").trim();
                              if (!amount) { alert("è¯·è¾“å…¥é‡‘é¢"); return; }
                              const res = await fetch(apiUrl("transactions"), {
                                method: "POST",
                                headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
                                body: JSON.stringify({ type, amount, note, category: type === "income" ? "æ”¶å…¥" : "æ”¯å‡º" }),
                              });
                              const data = await res.json();
                              if (data.error) alert(data.error);
                              else {
                                const fin = await fetch(apiUrl("finance/overview"), { headers: { Authorization: "Bearer " + token } });
                                const finData = await fin.json();
                                if (!finData.error) setFinance(finData);
                                refreshHome();
                                document.getElementById("tx-amount").value = "";
                                document.getElementById("tx-note").value = "";
                              }
                            }}
                          >
                            è®°ä¸€ç¬”
                          </button>
                        </div>
                      </div>

                      <div className="finance-card">
                        <h4>ğŸ“’ æµæ°´ï¼ˆæœ€è¿‘ 50 ç¬”ï¼‰</h4>
                        <ul className="tx-list">
                          {(finance.transactions || []).map(function (t) {
                            const sign = t.type === "income" ? "+" : "-";
                            const color = t.type === "income" ? "#16a34a" : "#dc2626";
                            return (
                              <li key={t.id}>
                                <span style={{ color: "#333" }}>{t.category}{t.note ? " Â· " + t.note : ""}</span>
                                <span style={{ color, fontWeight: 700 }}>{sign}Â¥{Number(t.amount).toFixed(2)}</span>
                              </li>
                            );
                          })}
                        </ul>
                      </div>
                    </div>
                  </React.Fragment>
                )}
              </div>
            )}

            {view === "shop" && (
              <div className="shop-page">
                <h3 style={{ marginBottom: 16, fontSize: 18 }}>ğŸª å¥–åŠ±ä¸­å¿ƒ</h3>
                <div style={{ display: "flex", gap: 8, marginBottom: 12 }}>
                  <button
                    className={"btn " + (shopTab === "official" ? "btn-primary" : "btn-outline")}
                    onClick={() => setShopTab("official")}
                  >
                    å®˜æ–¹å•†åŸ
                  </button>
                  <button
                    className={"btn " + (shopTab === "wish" ? "btn-primary" : "btn-outline")}
                    onClick={() => setShopTab("wish")}
                  >
                    æˆ‘çš„å¿ƒæ„¿æ± 
                  </button>
                </div>

                {shopTab === "official" && (
                  <React.Fragment>
                    <p style={{ fontSize: 12, color: "#666", marginBottom: 12 }}>
                      å®˜æ–¹é¢„è®¾å¥–åŠ±ï¼šå…‘æ¢ä¼šè‡ªåŠ¨æ‰£é‡‘å¸ + å†™æµæ°´ + è®¡å…¥æœ¬æœˆè‡ªæˆ‘å¥–åŠ±é¢„ç®—
                    </p>
                    <div className="shop-grid">
                      {shopItems.map(function (it) {
                        return (
                          <div key={it.id} className="shop-item">
                            <h4>{(it.icon || "ğŸ") + " " + it.name}</h4>
                            <div className="shop-meta">çº¦å€¼ Â¥{it.rmbValue} Â· ä»·æ ¼ {it.coinCost} é‡‘å¸</div>
                            <div style={{ fontSize: 13, color: "#444" }}>{it.description || ""}</div>
                            <button className="btn btn-primary redeem-btn" onClick={() => setRedeemItem(it)}>
                              å…‘æ¢
                            </button>
                          </div>
                        );
                      })}
                    </div>
                  </React.Fragment>
                )}

                {shopTab === "wish" && (
                  <React.Fragment>
                    <p style={{ fontSize: 12, color: "#666", marginBottom: 8 }}>
                      æŠŠé‡‘å¸å­˜è¿›è‡ªå·±çš„å¿ƒæ„¿æ± ï¼Œè€Œä¸ä»…ä»…æ˜¯ä¹°â€œä¸œè¥¿â€ã€‚
                    </p>
                    {(() => {
                      const active = (wishList || []).filter(function (w) { return w.status !== "redeemed"; });
                      const totalTarget = active.reduce(function (s, w) { return s + (w.targetCoins || 0); }, 0);
                      const totalCurrent = active.reduce(function (s, w) { return s + (w.currentCoins || 0); }, 0);
                      const pct = totalTarget ? Math.min(100, Math.floor((totalCurrent / totalTarget) * 100)) : 0;
                      return (
                        <div className="finance-card" style={{ marginBottom: 12 }}>
                          <h4>âœ¨ æˆ‘çš„å¿ƒæ„¿æ± æ€»å‚¨è“„è¿›åº¦</h4>
                          {totalTarget > 0 ? (
                            <React.Fragment>
                              <div style={{ fontSize: 13, color: "#444", marginBottom: 6 }}>
                                ç›®æ ‡ï¼šä¸º {active.length} ä¸ªå¿ƒæ„¿æ”’å¤Ÿ {totalTarget} é‡‘å¸ Â· å·²å‚¨è“„ï¼š{totalCurrent}/{totalTarget} é‡‘å¸
                              </div>
                              <div className="progress">
                                <div style={{ width: pct + "%" }} />
                              </div>
                            </React.Fragment>
                          ) : (
                            <p style={{ fontSize: 13, color: "#666" }}>è¿˜æ²¡æœ‰å¿ƒæ„¿ï¼Œå…ˆæ·»åŠ ä¸€ä¸ªä¸“å±å¥–åŠ±å§ã€‚</p>
                          )}
                        </div>
                      );
                    })()}

                    <div className="finance-card">
                      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 8 }}>
                        <h4 style={{ marginBottom: 0 }}>ğŸ¯ è¿›è¡Œä¸­çš„å¿ƒæ„¿</h4>
                        <button
                          className="btn btn-outline"
                          onClick={() => setWishForm({ id: null, name: "", description: "", category: "ä½“éªŒ", targetCoins: 600, estimatedRmb: 60 })}
                        >
                          ï¼‹ æ·»åŠ æ–°å¿ƒæ„¿
                        </button>
                      </div>
                      <div className="shop-grid">
                        {(wishList || []).filter(function (w) { return w.status !== "redeemed"; }).map(function (w, idx) {
                          const pct = w.targetCoins ? Math.min(100, Math.floor((w.currentCoins || 0) / w.targetCoins * 100)) : 0;
                          const ready = (w.currentCoins || 0) >= (w.targetCoins || 0);
                          return (
                            <div key={idx} className="shop-item" style={{ alignItems: "stretch" }}>
                              <h4>{w.emoji || "ğŸ’"} {w.name}</h4>
                              <div className="shop-meta">
                                {w.currentCoins || 0}/{w.targetCoins || 0} é‡‘å¸
                                {w.estimatedRmb ? ` Â· çº¦ Â¥${w.estimatedRmb}` : ""}
                              </div>
                              {w.description && <div style={{ fontSize: 12, color: "#666", marginBottom: 6 }}>{w.description}</div>}
                              <div className="progress" style={{ marginTop: 4 }}>
                                <div style={{ width: pct + "%" }} />
                              </div>
                              <div style={{ display: "flex", gap: 8, marginTop: 8 }}>
                                <button
                                  className="btn btn-outline"
                                  style={{ flex: 1, fontSize: 12 }}
                                  onClick={() => {
                                    const amount = Number(window.prompt("æœ¬æ¬¡ä¸ºè¯¥å¿ƒæ„¿å­˜å…¥å¤šå°‘é‡‘å¸ï¼Ÿ", "50") || 0);
                                    if (!amount) return;
                                    (async () => {
                                      try {
                                        const res = await fetch(apiUrl("wish-rewards/" + w.id + "/save"), {
                                          method: "POST",
                                          headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
                                          body: JSON.stringify({ amountCoins: amount }),
                                        });
                                        const data = await res.json();
                                        if (!data.success) { window.alert(data.error || "å‚¨è“„å¤±è´¥"); return; }
                                        setWishList((wishList || []).map(function (x) { return x.id === data.wish.id ? data.wish : x; }));
                                        refreshHome();
                                      } catch (e) { window.alert("å‚¨è“„å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æ˜¯å¦è¿è¡Œ"); }
                                    })();
                                  }}
                                >
                                  ç‚¹æˆ‘å‚¨è“„
                                </button>
                                <button
                                  className="btn btn-outline"
                                  style={{ fontSize: 12 }}
                                  onClick={() => setWishForm({ ...w })}
                                >
                                  ç¼–è¾‘
                                </button>
                                <button
                                  className={"btn " + (ready ? "btn-primary" : "btn-outline")}
                                  style={{ fontSize: 12 }}
                                  disabled={!ready}
                                  onClick={() => {
                                    (async () => {
                                      try {
                                        const res = await fetch(apiUrl("wish-rewards/" + w.id + "/redeem"), {
                                          method: "POST",
                                          headers: { Authorization: "Bearer " + token },
                                        });
                                        const data = await res.json();
                                        if (!data.success) { window.alert(data.error || "å…‘æ¢å¤±è´¥"); return; }
                                        window.alert("å¿ƒæ„¿å·²è¾¾æˆï¼å»ºè®®å†™ä¸€ç¯‡å°å¤ç›˜ï¼Œè®°å½•è¿™æ¬¡åœ†æ¢¦çš„æ„Ÿå—ã€‚");
                                        setWishList((wishList || []).map(function (x) { return x.id === data.wish.id ? data.wish : x; }));
                                        try {
                                          const fin = await fetch(apiUrl("finance/overview"), { headers: { Authorization: "Bearer " + token } });
                                          const finData = await fin.json();
                                          if (!finData.error) setFinance(finData);
                                        } catch (e) {}
                                        refreshHome();
                                      } catch (e) { window.alert("å…‘æ¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æ˜¯å¦è¿è¡Œ"); }
                                    })();
                                  }}
                                >
                                  {ready ? "å»å…‘æ¢" : "æœªè¾¾æ ‡"}
                                </button>
                              </div>
                            </div>
                          );
                        })}
                        {(wishList || []).filter(function (w) { return w.status !== "redeemed"; }).length === 0 && (
                          <p style={{ fontSize: 13, color: "#666" }}>è¿˜æ²¡æœ‰è¿›è¡Œä¸­çš„å¿ƒæ„¿ï¼Œç‚¹å‡»å³ä¸Šè§’â€œæ·»åŠ æ–°å¿ƒæ„¿â€ã€‚</p>
                        )}
                      </div>
                    </div>
                  </React.Fragment>
                )}
              </div>
            )}

            {redeemItem && finance && (
              <div className="modal-overlay" onClick={() => !redeeming && setRedeemItem(null)}>
                <div className="modal" onClick={(e) => e.stopPropagation()}>
                  <h3>ç¡®è®¤å…‘æ¢</h3>
                  <p>å•†å“ï¼š<strong>{redeemItem.name}</strong></p>
                  <p>æ¶ˆè€—ï¼š{redeemItem.coinCost} é‡‘å¸ï¼ˆçº¦ Â¥{redeemItem.rmbValue}ï¼‰</p>
                  <p style={{ color: "#667eea" }}>
                    æœ¬æœˆè‡ªæˆ‘å¥–åŠ±é¢„ç®—å‰©ä½™ï¼šÂ¥{Math.max(0, Number(finance.budget.rewardLimitRmb || 0) - Number(finance.budget.rewardSpentRmb || 0)).toFixed(0)}
                  </p>
                  <div className="actions">
                    <button className="btn btn-outline" disabled={redeeming} onClick={() => setRedeemItem(null)}>å–æ¶ˆ</button>
                    <button
                      className="btn btn-primary"
                      disabled={redeeming}
                      onClick={async () => {
                        setRedeeming(true);
                        try {
                          const res = await fetch(apiUrl("rewards/redeem"), {
                            method: "POST",
                            headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
                            body: JSON.stringify({ rewardItemId: redeemItem.id }),
                          });
                          const data = await res.json();
                          if (!data.success) alert(data.error || "å…‘æ¢å¤±è´¥");
                          else {
                            // åˆ·æ–°è´¢åŠ¡ä¸ä¸»é¡µ
                            const fin = await fetch(apiUrl("finance/overview"), { headers: { Authorization: "Bearer " + token } });
                            const finData = await fin.json();
                            if (!finData.error) setFinance(finData);
                            refreshHome();
                            setRedeemItem(null);
                            alert("å…‘æ¢æˆåŠŸï¼Œå·²è‡ªåŠ¨è®°è´¦ï¼");
                          }
                        } finally {
                          setRedeeming(false);
                        }
                      }}
                    >
                      {redeeming ? "å…‘æ¢ä¸­..." : "ç¡®è®¤å…‘æ¢"}
                    </button>
                  </div>
                </div>
              </div>
            )}

            {showSupplyModal && (
              <div className="modal-overlay" onClick={() => !savingSupply && setShowSupplyModal(false)}>
                <div className="modal" onClick={(e) => e.stopPropagation()}>
                  <h3>âš¡ å¿«é€Ÿåˆ›å»ºæƒ…æ™¯è¡¥ç»™åŒ…</h3>
                  <p style={{ fontSize: 12, color: "#666" }}>å…ˆé€‰æ‹©ä¸€ä¸ªå¸¸è§åœºæ™¯ï¼Œå†å¾®è°ƒåç§°å’Œæ•ˆæœå³å¯ã€‚</p>
                  <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8, marginBottom: 12, fontSize: 13 }}>
                    {[
                      { key: "deep_work", label: "ğŸ§  æ·±åº¦å·¥ä½œå", preset: { name: "æ€ç»´é‡å¯", effects: { water: 8, fire: 5 } } },
                      { key: "exercise", label: "ğŸƒ è¿åŠ¨å¥èº«å", preset: { name: "è¿åŠ¨èˆ’ç¼“", effects: { water: 6, fire: 6 } } },
                      { key: "low_mood", label: "ğŸ˜¤ æƒ…ç»ªä½è½æ—¶", preset: { name: "æƒ…ç»ªä¿®å¤", effects: { water: 10 } } },
                      { key: "overtime", label: "ğŸ’¤ ç†¬å¤œåŠ ç­å", preset: { name: "é€šå®µä¿®å¤", effects: { water: 6, fire: 8 } } },
                      { key: "pre_challenge", label: "ğŸ¯ æŒ‘æˆ˜å¼€å§‹å‰", preset: { name: "æˆ˜å‰åŠ¨å‘˜", effects: { fire: 10, earth: 5 } } },
                      { key: "celebration", label: "ğŸ‰ åº†ç¥æˆå°±æ—¶", preset: { name: "åº†åŠŸç‰¹é¥®", effects: { water: 6, fire: 4 } } },
                    ].map(function (tpl) {
                      return (
                        <button
                          key={tpl.key}
                          className="btn btn-outline"
                          style={{ textAlign: "left", fontSize: 13 }}
                          onClick={() => {
                            setSupplyForm({
                              scenario: tpl.key,
                              name: tpl.preset.name,
                              description: "",
                              effects: {
                                wood: 0,
                                fire: tpl.preset.effects.fire || 0,
                                earth: tpl.preset.effects.earth || 0,
                                metal: 0,
                                water: tpl.preset.effects.water || 0,
                              },
                              cooldownMinutes: 30,
                            });
                          }}
                        >
                          {tpl.label}
                        </button>
                      );
                    })}
                  </div>
                  <div className="retro-form">
                    <input
                      value={supplyForm.name}
                      onChange={(e) => setSupplyForm({ ...supplyForm, name: e.target.value })}
                      placeholder="è¡¥ç»™åŒ…åç§°ï¼Œå¦‚ï¼šæ€ç»´é‡å¯"
                      style={{ padding: "10px 12px", borderRadius: 12, border: "1px solid #ccc" }}
                    />
                    <input
                      value={supplyForm.description}
                      onChange={(e) => setSupplyForm({ ...supplyForm, description: e.target.value })}
                      placeholder="å¯¹ä½ çš„æ„ä¹‰ï¼ˆå¯é€‰ï¼‰"
                      style={{ padding: "10px 12px", borderRadius: 12, border: "1px solid #ccc" }}
                    />
                    <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8 }}>
                      {["water", "fire", "earth", "wood", "metal"].map(function (k) {
                        const label = k === "water" ? "æ°´Â·å¿ƒæƒ…" : k === "fire" ? "ç«Â·ç²¾åŠ›" : k === "earth" ? "åœŸÂ·æ™ºæ…§" : k === "wood" ? "æœ¨Â·å¥åº·" : "é‡‘Â·è´¢å¯Œ";
                        return (
                          <div key={k} style={{ fontSize: 12 }}>
                            <div>{label} æ•ˆæœï¼ˆå¯æ­£å¯è´Ÿï¼‰</div>
                            <input
                              type="number"
                              value={supplyForm.effects[k] || 0}
                              onChange={(e) => setSupplyForm({ ...supplyForm, effects: { ...supplyForm.effects, [k]: Number(e.target.value || 0) } })}
                              style={{ width: "100%", padding: "6px 8px", borderRadius: 10, border: "1px solid #ccc" }}
                            />
                          </div>
                        );
                      })}
                    </div>
                    <div style={{ display: "flex", gap: 10, alignItems: "center" }}>
                      <span style={{ fontSize: 12 }}>å†·å´æ—¶é—´ï¼ˆåˆ†é’Ÿï¼Œå¯é€‰ï¼‰</span>
                      <input
                        type="number"
                        value={supplyForm.cooldownMinutes || 0}
                        onChange={(e) => setSupplyForm({ ...supplyForm, cooldownMinutes: Number(e.target.value || 0) })}
                        style={{ width: 80, padding: "6px 8px", borderRadius: 10, border: "1px solid #ccc" }}
                      />
                    </div>
                    <p style={{ fontSize: 12, color: "#666" }}>æç¤ºï¼šæ•ˆæœå€¼å»ºè®®åœ¨ -20 åˆ° +20 ä¹‹é—´ï¼Œè¶Šå¤§ä»£è¡¨è¡¥ç»™è¶Šâ€œçŒ›â€ã€‚</p>
                    <div className="actions">
                      <button className="btn btn-outline" disabled={savingSupply} onClick={() => setShowSupplyModal(false)}>å–æ¶ˆ</button>
                      <button
                        className="btn btn-primary"
                        disabled={savingSupply}
                        onClick={async () => {
                          if (!supplyForm.name) { window.alert("è¯·å…ˆå¡«å†™åç§°"); return; }
                          setSavingSupply(true);
                          try {
                            const res = await fetch(apiUrl("supply-packs/custom"), {
                              method: "POST",
                              headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
                              body: JSON.stringify({
                                scenario: supplyForm.scenario,
                                name: supplyForm.name,
                                description: supplyForm.description,
                                effects: supplyForm.effects,
                                cooldownMinutes: supplyForm.cooldownMinutes,
                              }),
                            });
                            const data = await res.json();
                            if (!data.success) { window.alert(data.error || "ä¿å­˜å¤±è´¥"); return; }
                            window.alert("å·²ä¸ºä½ åˆ›å»ºä¸€ä¸ªæ–°çš„æƒ…æ™¯è¡¥ç»™åŒ…ï¼Œå¹¶å‘æ”¾ 1 ä»½åˆ°èƒŒåŒ…ã€‚");
                            setShowSupplyModal(false);
                            refreshHome();
                          } catch (e) {
                            window.alert("ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æ˜¯å¦è¿è¡Œ");
                          } finally {
                            setSavingSupply(false);
                          }
                        }}
                      >
                        {savingSupply ? "ä¿å­˜ä¸­..." : "ä¿å­˜è¡¥ç»™åŒ…"}
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {wishForm && (
              <div className="modal-overlay" onClick={() => setWishForm(null)}>
                <div className="modal" onClick={(e) => e.stopPropagation()}>
                  <h3>{wishForm.id ? "ç¼–è¾‘å¿ƒæ„¿" : "æ·»åŠ æ–°å¿ƒæ„¿"}</h3>
                  <div className="retro-form">
                    <input
                      value={wishForm.name}
                      onChange={(e) => setWishForm({ ...wishForm, name: e.target.value })}
                      placeholder="å¥–åŠ±åç§°ï¼Œå¦‚ï¼šä¸€æ¬¡éœ²è¥ä¹‹æ—…"
                      style={{ padding: "10px 12px", borderRadius: 12, border: "1px solid #ccc" }}
                    />
                    <input
                      value={wishForm.description || ""}
                      onChange={(e) => setWishForm({ ...wishForm, description: e.target.value })}
                      placeholder="å¯¹æˆ‘è€Œè¨€çš„æ„ä¹‰ï¼Œå¦‚ï¼šåº†ç¥å®Œæˆé‡è¦é¡¹ç›®"
                      style={{ padding: "10px 12px", borderRadius: 12, border: "1px solid #ccc" }}
                    />
                    <div style={{ display: "flex", gap: 10, flexWrap: "wrap" }}>
                      <select
                        value={wishForm.category || "ä½“éªŒ"}
                        onChange={(e) => setWishForm({ ...wishForm, category: e.target.value })}
                        style={{ padding: "10px 12px", borderRadius: 12, border: "1px solid #ccc" }}
                      >
                        <option value="ä½“éªŒ">ä½“éªŒ</option>
                        <option value="å®ç‰©">å®ç‰©</option>
                        <option value="å­¦ä¹ ">å­¦ä¹ </option>
                        <option value="å¥åº·">å¥åº·</option>
                        <option value="æ”¾çºµ">æ”¾çºµ</option>
                      </select>
                      <input
                        type="number"
                        value={wishForm.targetCoins || 0}
                        onChange={(e) => setWishForm({ ...wishForm, targetCoins: Number(e.target.value || 0) })}
                        placeholder="ç›®æ ‡é‡‘å¸æ•°ï¼Œå¦‚ 600"
                        style={{ padding: "10px 12px", borderRadius: 12, border: "1px solid #ccc", flex: 1, minWidth: 120 }}
                      />
                      <input
                        type="number"
                        value={wishForm.estimatedRmb || ""}
                        onChange={(e) => setWishForm({ ...wishForm, estimatedRmb: Number(e.target.value || 0) })}
                        placeholder="çº¦å€¼äººæ°‘å¸ï¼ˆå¯é€‰ï¼‰"
                        style={{ padding: "10px 12px", borderRadius: 12, border: "1px solid #ccc", flex: 1, minWidth: 120 }}
                      />
                    </div>
                    <p style={{ fontSize: 12, color: "#666" }}>å»ºè®®ï¼šçº¦ 1 å…ƒ â‰ˆ 10 é‡‘å¸ï¼Œå¯å¤§è‡´å¯¹åº”ä½ çš„è´¢åŠ¡é¢„ç®—ã€‚</p>
                    <div style={{ display: "flex", gap: 8, justifyContent: "flex-end" }}>
                      <button className="btn btn-outline" onClick={() => setWishForm(null)}>å–æ¶ˆ</button>
                      <button
                        className="btn btn-primary"
                        onClick={async () => {
                          if (!wishForm.name || !wishForm.targetCoins) {
                            window.alert("è¯·è‡³å°‘å¡«å†™åç§°å’Œç›®æ ‡é‡‘å¸æ•°");
                            return;
                          }
                          try {
                            if (wishForm.id) {
                              const res = await fetch(apiUrl("wish-rewards/" + wishForm.id), {
                                method: "PATCH",
                                headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
                                body: JSON.stringify({
                                  name: wishForm.name,
                                  description: wishForm.description,
                                  category: wishForm.category,
                                  targetCoins: wishForm.targetCoins,
                                  estimatedRmb: wishForm.estimatedRmb,
                                }),
                              });
                              const data = await res.json();
                              if (!data.success) { window.alert(data.error || "ä¿å­˜å¤±è´¥"); return; }
                              setWishList((wishList || []).map(function (w) { return w.id === data.wish.id ? data.wish : w; }));
                            } else {
                              const res = await fetch(apiUrl("wish-rewards"), {
                                method: "POST",
                                headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
                                body: JSON.stringify({
                                  name: wishForm.name,
                                  description: wishForm.description,
                                  category: wishForm.category,
                                  targetCoins: wishForm.targetCoins,
                                  estimatedRmb: wishForm.estimatedRmb,
                                }),
                              });
                              const data = await res.json();
                              if (!data.success) { window.alert(data.error || "ä¿å­˜å¤±è´¥"); return; }
                              setWishList([...(wishList || []), data.wish]);
                            }
                            setWishForm(null);
                          } catch (e) { window.alert("ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æ˜¯å¦è¿è¡Œ"); }
                        }}
                      >
                        ä¿å­˜å¿ƒæ„¿
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {view === "entertainment" && (
              <div className="ent-page">
                <h3 style={{ marginBottom: 16, fontSize: 18 }}>ğŸ® å¨±ä¹è®°å½•</h3>
                <p style={{ fontSize: 12, color: "#666", marginBottom: 12 }}>é€‚å½“å¨±ä¹æœ‰åŠ©äºå¿ƒæƒ…æ¢å¤ï¼Œæ‰“å¡ä¸€æ¬¡è‡ªåŠ¨è®©å¿ƒæƒ… +5</p>
                <div className="ent-form">
                  <input id="ent-activity" placeholder="å¨±ä¹æ´»åŠ¨ï¼ˆå¦‚ï¼šæ¸¸æˆ 30 åˆ†é’Ÿï¼‰" style={{ flex: 1, minWidth: 200, padding: "10px 12px", borderRadius: 12, border: "1px solid #ccc" }} />
                  <input id="ent-duration" placeholder="æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼Œå¯é€‰ï¼‰" style={{ width: 160, padding: "10px 12px", borderRadius: 12, border: "1px solid #ccc" }} />
                  <button
                    className="btn btn-primary"
                    onClick={async () => {
                      const act = (document.getElementById("ent-activity").value || "").trim() || "å¨±ä¹";
                      const dur = Number((document.getElementById("ent-duration").value || "").trim() || 0);
                      try {
                        const res = await fetch(apiUrl("entertainment/log"), {
                          method: "POST",
                          headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
                          body: JSON.stringify({ activity: act, duration: dur }),
                        });
                        const data = await res.json();
                        if (data.error) alert(data.error);
                        else {
                          refreshHome();
                          const r = await fetch(apiUrl("entertainment/logs"), { headers: { Authorization: "Bearer " + token } });
                          const logs = await r.json();
                          if (!logs.error && logs.logs) setEntLogs(logs.logs);
                          document.getElementById("ent-activity").value = "";
                          document.getElementById("ent-duration").value = "";
                          alert("å¨±ä¹å·²æ‰“å¡ï¼Œå¿ƒæƒ… +5");
                        }
                      } catch (e) { alert("æäº¤å¤±è´¥"); }
                    }}
                  >
                    è®°å½•å¨±ä¹
                  </button>
                </div>
                <div className="finance-card" style={{ marginTop: 10 }}>
                  <h4>æœ€è¿‘å¨±ä¹è®°å½•</h4>
                  {(entLogs || []).slice(0,5).map(function (l) {
                    return (
                      <div key={l.id} style={{ fontSize: 13, padding: "6px 0", borderBottom: "1px solid #eee" }}>
                        {l.activity} {l.duration ? `Â· ${l.duration} åˆ†é’Ÿ` : ""} Â· {new Date(l.at).toLocaleString("zh-CN")}
                      </div>
                    );
                  })}
                  {(!entLogs || entLogs.length === 0) && <p style={{ fontSize: 12, color: "#666" }}>æš‚æ— è®°å½•</p>}
                </div>
              </div>
            )}

            {view === "motivation" && (
              <div className="mot-page">
                <h3 style={{ marginBottom: 4, fontSize: 18 }}>ğŸ’¬ åŠ±å¿—å¢™ Â· å¿ƒçµé©¿ç«™</h3>
                <p style={{ fontSize: 12, color: "#666", marginBottom: 10 }}>
                  å‘å¸ƒä¸€å¥è¯ç»™ç°åœ¨çš„è‡ªå·± / æŒ‘æˆ˜åŒè·¯äººï¼Œä¹Ÿå¯ä»¥å†™ä¸€å°ä¿¡ç»™æœªæ¥çš„è‡ªå·±ã€‚
                </p>

                <div className="finance-card">
                  <div style={{ display: "flex", gap: 8, marginBottom: 10, flexWrap: "wrap" }}>
                    <button className={"btn " + (motivationTab === "recommend" ? "btn-primary" : "btn-outline")} onClick={() => setMotivationTab("recommend")}>æ¨èå¢™</button>
                    <button className={"btn " + (motivationTab === "milestone" ? "btn-primary" : "btn-outline")} onClick={() => setMotivationTab("milestone")}>é‡Œç¨‹ç¢‘å¢™</button>
                    <button className={"btn " + (motivationTab === "mine" ? "btn-primary" : "btn-outline")} onClick={() => setMotivationTab("mine")}>æˆ‘çš„ç•™è¨€</button>
                    <button className={"btn " + (motivationTab === "capsule" ? "btn-primary" : "btn-outline")} onClick={() => setMotivationTab("capsule")}>æ—¶å…‰èƒ¶å›Š</button>
                  </div>

                  {motivationTab !== "capsule" && (
                    <div className="retro-form">
                      <textarea
                        value={motivationInput}
                        onChange={(e) => setMotivationInput(e.target.value)}
                        placeholder="æƒ³å¯¹ç°åœ¨æˆ–æœªæ¥çš„è‡ªå·±/åŒè·¯äººè¯´äº›ä»€ä¹ˆï¼Ÿ"
                      />
                      <button
                        className="btn btn-primary"
                        disabled={motivationLoading}
                        onClick={async () => {
                          const text = (motivationInput || "").trim();
                          if (!text) { window.alert("å…ˆå†™ç‚¹ä»€ä¹ˆå§"); return; }
                          setMotivationLoading(true);
                          try {
                            const res = await fetch(apiUrl("motivation/posts"), {
                              method: "POST",
                              headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
                              body: JSON.stringify({ text }),
                            });
                            const data = await res.json();
                            if (!data.success) window.alert(data.error || "å‘å¸ƒå¤±è´¥");
                            else {
                              setMotivationInput("");
                              // é‡æ–°æ‹‰å–å½“å‰ tab
                              try {
                                const q = motivationTab === "mine" ? "?filter=mine" : (motivationTab === "milestone" ? "?filter=milestone" : "");
                                const listRes = await fetch(apiUrl("motivation/posts" + q), { headers: { Authorization: "Bearer " + token } });
                                const listData = await listRes.json();
                                if (!listData.error) setMotivationPosts(listData.posts || []);
                              } catch (e) {}
                            }
                          } catch (e) {
                            window.alert("å‘å¸ƒå¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æ˜¯å¦è¿è¡Œ");
                          } finally {
                            setMotivationLoading(false);
                          }
                        }}
                      >
                        {motivationLoading ? "å‘å¸ƒä¸­..." : "å‘å¸ƒä¸€å¥è¯"}
                      </button>
                    </div>
                  )}

                  {motivationTab !== "capsule" && (
                    <div className="mot-list">
                      {(motivationPosts || []).length === 0 && <p style={{ fontSize: 12, color: "#666" }}>è¿˜æ²¡æœ‰å†…å®¹ï¼Œå…ˆå‘å¸ƒä¸€æ¡å§ã€‚</p>}
                      {(motivationPosts || []).map(function (p) {
                        return (
                          <div key={p.id} className="mot-card">
                            <div className="mot-meta">
                              {new Date(p.createdAt).toLocaleString("zh-CN")} Â· {p.category === "milestone" ? "é‡Œç¨‹ç¢‘" : "æ—¥å¸¸"}
                              {p.linkedBossId ? " Â· å…³è”Boss" : ""}
                            </div>
                            <div style={{ fontSize: 13, whiteSpace: "pre-wrap" }}>{p.text}</div>
                            <div className="mot-actions">
                              <span
                                style={{ cursor: "pointer", color: p.liked ? "#e11d48" : "#475569" }}
                                onClick={async () => {
                                  try {
                                    const res = await fetch(apiUrl("motivation/posts/" + p.id + "/like"), {
                                      method: "POST",
                                      headers: { Authorization: "Bearer " + token },
                                    });
                                    const data = await res.json();
                                    if (!data.success) { window.alert(data.error || "æ“ä½œå¤±è´¥"); return; }
                                    setMotivationPosts((motivationPosts || []).map(function (x) {
                                      return x.id === p.id ? { ...x, liked: data.liked, likesCount: data.likesCount } : x;
                                    }));
                                  } catch (e) { window.alert("æ“ä½œå¤±è´¥"); }
                                }}
                              >
                                â¤ï¸ {p.likesCount || 0}
                              </span>
                              <span
                                style={{ cursor: "pointer", color: p.bookmarked ? "#6366f1" : "#475569" }}
                                onClick={async () => {
                                  try {
                                    const res = await fetch(apiUrl("motivation/posts/" + p.id + "/bookmark"), {
                                      method: "POST",
                                      headers: { Authorization: "Bearer " + token },
                                    });
                                    const data = await res.json();
                                    if (!data.success) { window.alert(data.error || "æ“ä½œå¤±è´¥"); return; }
                                    setMotivationPosts((motivationPosts || []).map(function (x) {
                                      return x.id === p.id ? { ...x, bookmarked: data.bookmarked, bookmarksCount: data.bookmarksCount } : x;
                                    }));
                                  } catch (e) { window.alert("æ“ä½œå¤±è´¥"); }
                                }}
                              >
                                ğŸ“Œ {p.bookmarksCount || 0}
                              </span>
                              <span style={{ fontSize: 12, color: "#94a3b8" }}>è¯„è®º {p.commentsCount || 0}</span>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  )}

                  {motivationTab === "capsule" && (
                    <div>
                      <h4 style={{ marginBottom: 8 }}>âœ‰ï¸ å†™ä¸€å°ç»™æœªæ¥è‡ªå·±çš„ä¿¡</h4>
                      <div className="retro-form">
                        <input
                          value={capsuleForm.title}
                          onChange={(e) => setCapsuleForm({ ...capsuleForm, title: e.target.value })}
                          placeholder="æ ‡é¢˜ï¼ˆå¯é€‰ï¼Œå¦‚ï¼šä¸‰ä¸ªæœˆåçš„æˆ‘ï¼‰"
                          style={{ padding: "10px 12px", borderRadius: 12, border: "1px solid #ccc" }}
                        />
                        <textarea
                          value={capsuleForm.message}
                          onChange={(e) => setCapsuleForm({ ...capsuleForm, message: e.target.value })}
                          placeholder="å†™ç»™æœªæ¥çš„è‡ªå·±çš„è¯..."
                        />
                        <input
                          type="datetime-local"
                          value={capsuleForm.openAt}
                          onChange={(e) => setCapsuleForm({ ...capsuleForm, openAt: e.target.value })}
                          style={{ padding: "8px 10px", borderRadius: 12, border: "1px solid #ccc", maxWidth: 260 }}
                        />
                        <button
                          className="btn btn-primary"
                          onClick={async () => {
                            const msg = (capsuleForm.message || "").trim();
                            if (!msg) { window.alert("è¯·å…ˆå†™ç‚¹å†…å®¹"); return; }
                            try {
                              const res = await fetch(apiUrl("time-capsules"), {
                                method: "POST",
                                headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
                                body: JSON.stringify(capsuleForm),
                              });
                              const data = await res.json();
                              if (!data.success) { window.alert(data.error || "ä¿å­˜å¤±è´¥"); return; }
                              setCapsuleForm({ title: "", message: "", openAt: "" });
                              const listRes = await fetch(apiUrl("time-capsules"), { headers: { Authorization: "Bearer " + token } });
                              const listData = await listRes.json();
                              if (!listData.error) setCapsules(listData.capsules || []);
                            } catch (e) { window.alert("ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æ˜¯å¦è¿è¡Œ"); }
                          }}
                        >
                          ä¿å­˜æ—¶å…‰èƒ¶å›Š
                        </button>
                      </div>
                      <div className="mot-list">
                        {(capsules || []).length === 0 && <p style={{ fontSize: 12, color: "#666" }}>è¿˜æ²¡æœ‰èƒ¶å›Šï¼Œç»™æœªæ¥çš„è‡ªå·±å†™ç¬¬ä¸€å°ä¿¡å§ã€‚</p>}
                        {(capsules || []).map(function (c) {
                          const opened = c.opened || (c.openAt && new Date(c.openAt) <= new Date());
                          return (
                            <div key={c.id} className="mot-card">
                              <div className="mot-meta">
                                å°†åœ¨ {new Date(c.openAt).toLocaleString("zh-CN")} æ‰“å¼€ Â· {opened ? "å·²å¯æŸ¥çœ‹" : "å°šæœªåˆ°æœŸ"}
                              </div>
                              <div style={{ fontWeight: 600, fontSize: 13, marginBottom: 4 }}>{c.title || "å†™ç»™æœªæ¥çš„æˆ‘"}</div>
                              {opened && <div style={{ fontSize: 13, whiteSpace: "pre-wrap" }}>{c.message}</div>}
                              {!opened && <div style={{ fontSize: 12, color: "#94a3b8" }}>åˆ°è¾¾å¼€å¯æ—¶é—´åå³å¯æŸ¥çœ‹å†…å®¹</div>}
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  )}
                </div>
              </div>
            )}

            {view === "retrospect" && (
              <div className="retro-page">
                <h3 style={{ marginBottom: 16, fontSize: 18 }}>ğŸ§  å¤ç›˜</h3>
                <p style={{ fontSize: 12, color: "#666", marginBottom: 10 }}>åŒæ¨¡å¼èåˆç¼–è¾‘å™¨ï¼šé—®é¢˜å— + è‡ªç”±æ–‡æœ¬å—æ··æ’ï¼›å¯åˆ‡æ¢çº¯æ–‡æœ¬ï¼ˆè‡ªåŠ¨ç”Ÿæˆå¤§çº²ï¼‰</p>

                <div className="finance-card">
                  <h4>ğŸ“ åˆ›å»ºå¤ç›˜</h4>
                  <div className="mix-toolbar">
                    <button className={"btn " + (retroMode === "guided" ? "btn-primary" : "btn-outline")} onClick={() => setRetroMode("guided")}>â— å¼•å¯¼æ¨¡å¼</button>
                    <button className={"btn " + (retroMode === "free_text" ? "btn-primary" : "btn-outline")} onClick={() => {
                      if (retroMode === "guided") {
                        const outline = (mixBlocks || []).map((b, i) => {
                          if (b.type === "question") return `${i + 1}. ${b.question || "é—®é¢˜"}\n- ${b.answer || ""}`;
                          return `\nè‡ªç”±è®°å½•ï¼š\n${b.content || ""}`;
                        }).join("\n\n");
                        setFreeText(outline || freeText);
                      }
                      setRetroMode("free_text");
                    }}>â—‹ çº¯æ–‡æœ¬æ¨¡å¼</button>
                    <input id="mix-title" placeholder="æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰" style={{ flex: 1, minWidth: 180, padding: "10px 12px", borderRadius: 12, border: "1px solid #ccc" }} />
                    <select value={selectedTemplateId || ""} onChange={(e) => { setSelectedTemplateId(Number(e.target.value)); window.localStorage.setItem("lastTemplateId", e.target.value); }} style={{ padding: "10px 12px", borderRadius: 12, border: "1px solid #ccc", minWidth: 180 }}>
                      <optgroup label="â­ æˆ‘çš„æ¨¡æ¿">{(tplMine || []).map((t) => <option key={t.id} value={t.id}>{t.title}</option>)}</optgroup>
                      <optgroup label="ğŸ§  ç³»ç»Ÿæ¨¡æ¿">{(tplSystem || []).map((t) => <option key={t.id} value={t.id}>{t.title}</option>)}</optgroup>
                    </select>
                    <button className="btn btn-outline" onClick={() => {
                      const all = [...(tplMine || []), ...(tplSystem || [])];
                      const tpl = all.find((t) => t.id === selectedTemplateId) || all[0];
                      if (!tpl) return;
                      const blocks = (tpl.questions || []).map((q, idx) => ({ id: "q_" + Date.now() + "_" + idx, type: "question", qType: q.type || "text", question: q.question || "", max: q.max || 5, answer: q.type === "rating" ? null : "" }));
                      blocks.push({ id: "free_" + Date.now(), type: "free", content: "" });
                      setMixBlocks(blocks);
                      setRetroMode("guided");
                    }}>ä»æ¨¡æ¿åŠ è½½</button>
                    <button className="btn btn-outline" onClick={() => setTemplateDraft({ title: "", description: "", category: "è‡ªå®šä¹‰", isPublic: false, questions: [] })}>ä¿å­˜ä¸ºæ¨¡æ¿</button>
                  </div>

                  {retroMode === "guided" && (
                    <div style={{ marginTop: 10 }}>
                      <div style={{ display: "flex", gap: 10, marginBottom: 10, flexWrap: "wrap" }}>
                        <button className="btn btn-outline mix-mini" onClick={() => setMixBlocks([...(mixBlocks || []), { id: "q_" + Date.now(), type: "question", qType: "text", question: "æ–°é—®é¢˜â€¦", answer: "" }])}>â• æ·»åŠ é—®é¢˜</button>
                        <button className="btn btn-outline mix-mini" onClick={() => setMixBlocks([...(mixBlocks || []), { id: "free_" + Date.now(), type: "free", content: "" }])}>â• æ·»åŠ è‡ªç”±æ–‡æœ¬æ®µè½</button>
                      </div>
                      {(() => {
                        const insertAt = (at, block) => {
                          const arr = (mixBlocks || []).slice();
                          arr.splice(at, 0, block);
                          setMixBlocks(arr);
                        };
                        const reorderTo = (toIndex) => {
                          const fromId = mixDragId;
                          if (!fromId) return;
                          const arr = (mixBlocks || []).slice();
                          const fromIndex = arr.findIndex((x) => x.id === fromId);
                          if (fromIndex === -1) return;
                          const [item] = arr.splice(fromIndex, 1);
                          let target = toIndex;
                          if (fromIndex < toIndex) target = toIndex - 1;
                          arr.splice(target, 0, item);
                          setMixDragId(null);
                          setMixDropIndex(null);
                          setMixBlocks(arr);
                        };

                        const DropZone = function ({ index }) {
                          const over = mixDropIndex === index;
                          const hover = mixHoverInsertIndex === index;
                          return (
                            <div
                              className={"mix-dropzone" + (over ? " dragover" : "") + (hover ? " hover" : "")}
                              onMouseEnter={() => setMixHoverInsertIndex(index)}
                              onMouseLeave={() => setMixHoverInsertIndex(null)}
                              onDragOver={(e) => { e.preventDefault(); if (mixDragId) setMixDropIndex(index); }}
                              onDragLeave={() => { if (mixDropIndex === index) setMixDropIndex(null); }}
                              onDrop={(e) => { e.preventDefault(); reorderTo(index); }}
                            >
                              <div className="mix-insert">
                                <button className="btn btn-outline mix-mini" onClick={() => insertAt(index, { id: "q_" + Date.now(), type: "question", qType: "text", question: "æ–°é—®é¢˜â€¦", answer: "" })}>åœ¨æ­¤æ’å…¥é—®é¢˜</button>
                                <button className="btn btn-outline mix-mini" onClick={() => insertAt(index, { id: "free_" + Date.now(), type: "free", content: "" })}>åœ¨æ­¤æ’å…¥è‡ªç”±æ®µè½</button>
                              </div>
                            </div>
                          );
                        };

                        return (
                          <div>
                            <DropZone index={0} />
                            {(mixBlocks || []).map(function (b, idx) {
                              const move = (dir) => {
                                const arr = (mixBlocks || []).slice();
                                const ni = idx + dir;
                                if (ni < 0 || ni >= arr.length) return;
                                const tmp = arr[idx]; arr[idx] = arr[ni]; arr[ni] = tmp;
                                setMixBlocks(arr);
                              };
                              const remove = () => setMixBlocks((mixBlocks || []).filter((x) => x.id !== b.id));
                              const onDragStart = () => { setMixDragId(b.id); };
                              const onDragEnd = () => { setMixDragId(null); setMixDropIndex(null); };
                        if (b.type === "free") {
                          return (
                            <div key={b.id} className={"mix-block" + (mixDragId === b.id ? " dragging" : "")} draggable onDragStart={onDragStart} onDragEnd={onDragEnd}>
                              <div className="mix-block-head">
                                <div style={{ display: "flex", gap: 10, alignItems: "center" }}>
                                  <span className="mix-handle">æ‹–æ‹½</span>
                                  <strong>è‡ªç”±æ–‡æœ¬æ®µè½</strong>
                                </div>
                                <div className="mix-block-actions">
                                  <button className="btn btn-outline mix-mini" onClick={() => move(-1)}>â†‘</button>
                                  <button className="btn btn-outline mix-mini" onClick={() => move(1)}>â†“</button>
                                  <button className="btn btn-outline mix-mini" onClick={remove}>ğŸ—‘ï¸</button>
                                </div>
                              </div>
                              <textarea value={b.content || ""} onChange={(e) => {
                                const arr = (mixBlocks || []).slice();
                                arr[idx] = { ...b, content: e.target.value };
                                setMixBlocks(arr);
                              }} placeholder="è‡ªç”±è®°å½•â€¦" style={{ width: "100%", minHeight: 80, padding: 10, borderRadius: 12, border: "1px solid #ccc" }} />
                            </div>
                          );
                        }
                        return (
                          <div key={b.id} className={"mix-block" + (mixDragId === b.id ? " dragging" : "")} draggable onDragStart={onDragStart} onDragEnd={onDragEnd}>
                            <div className="mix-block-head">
                              <div style={{ display: "flex", gap: 10, alignItems: "center", flexWrap: "wrap" }}>
                                <span className="mix-handle">æ‹–æ‹½</span>
                                <span style={{ fontWeight: 700 }}>{idx + 1}.</span>
                                <input value={b.question || ""} onChange={(e) => {
                                  const arr = (mixBlocks || []).slice();
                                  arr[idx] = { ...b, question: e.target.value };
                                  setMixBlocks(arr);
                                }} style={{ padding: "8px 10px", borderRadius: 10, border: "1px solid #ccc", minWidth: 240 }} />
                                <select value={b.qType || "text"} onChange={(e) => {
                                  const arr = (mixBlocks || []).slice();
                                  arr[idx] = { ...b, qType: e.target.value };
                                  setMixBlocks(arr);
                                }} style={{ padding: "8px 10px", borderRadius: 10, border: "1px solid #ccc" }}>
                                  <option value="text">æ–‡æœ¬</option>
                                  <option value="rating">è¯„åˆ†</option>
                                </select>
                              </div>
                              <div className="mix-block-actions">
                                <button className="btn btn-outline mix-mini" onClick={() => move(-1)}>â†‘</button>
                                <button className="btn btn-outline mix-mini" onClick={() => move(1)}>â†“</button>
                                <button className="btn btn-outline mix-mini" onClick={remove}>ğŸ—‘ï¸</button>
                              </div>
                            </div>
                            {b.qType === "rating" ? (
                              <select value={b.answer == null ? "" : b.answer} onChange={(e) => {
                                const arr = (mixBlocks || []).slice();
                                arr[idx] = { ...b, answer: Number(e.target.value) };
                                setMixBlocks(arr);
                              }} style={{ padding: "10px 12px", borderRadius: 12, border: "1px solid #ccc", width: "100%" }}>
                                <option value="">è¯·é€‰æ‹©</option>
                                {Array.from({ length: b.max || 5 }).map((_, i) => <option key={i + 1} value={i + 1}>{i + 1}</option>)}
                              </select>
                            ) : (
                              <textarea value={b.answer || ""} onChange={(e) => {
                                const arr = (mixBlocks || []).slice();
                                arr[idx] = { ...b, answer: e.target.value };
                                setMixBlocks(arr);
                              }} placeholder="å†™ä¸‹ä½ çš„ç­”æ¡ˆâ€¦" style={{ width: "100%", minHeight: 70, padding: 10, borderRadius: 12, border: "1px solid #ccc" }} />
                            )}
                          </div>
                        );
                            })}
                            <DropZone index={(mixBlocks || []).length} />
                          </div>
                        );
                      })()}
                    </div>
                  )}

                  {retroMode === "free_text" && (
                    <div style={{ marginTop: 10 }}>
                      <textarea value={freeText} onChange={(e) => setFreeText(e.target.value)} placeholder="çº¯æ–‡æœ¬ï¼ˆå¯å†™ Markdownï¼‰â€¦" style={{ width: "100%", minHeight: 320, padding: 12, borderRadius: 14, border: "1px solid #ccc" }} />
                    </div>
                  )}

                  <div style={{ display: "flex", gap: 10, marginTop: 12 }}>
                    <button className="btn btn-primary" onClick={async () => {
                      const title = (document.getElementById("mix-title").value || "").trim() || "å¤ç›˜";
                      const contentType = retroMode === "free_text" ? "free_text" : "qa_mixed";
                      const qaData = contentType === "qa_mixed" ? {
                        template_id: selectedTemplateId || null,
                        blocks: (mixBlocks || []).map((b, i) => (b.type === "question"
                          ? ({ id: b.id, type: "question", qType: b.qType || "text", question: b.question, answer: b.answer, max: b.max || 5, order: i + 1 })
                          : ({ id: b.id, type: "free", content: b.content, order: i + 1 })
                        )),
                        // å…¼å®¹æ—§ç»“æ„ï¼ˆç»™åç«¯/æ—§å±•ç¤ºç•™å£å­ï¼‰
                        questions: (mixBlocks || []).filter((b) => b.type === "question").map((b, i) => ({ id: b.id, question: b.question, type: b.qType || "text", answer: b.answer, order: i + 1 })),
                        free_sections: (mixBlocks || []).filter((b) => b.type === "free").map((b, i) => ({ id: b.id, content: b.content, order: i + 1.5 })),
                      } : null;
                      const res = await fetch(apiUrl("retrospects/v2"), {
                        method: "POST",
                        headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
                        body: JSON.stringify({ title, contentType, freeContent: contentType === "free_text" ? freeText : null, qaData }),
                      });
                      const data = await res.json();
                      if (data.error) alert(data.error);
                      else {
                        const r = await fetch(apiUrl("retrospects/v2"), { headers: { Authorization: "Bearer " + token } });
                        const d = await r.json();
                        if (!d.error) { setRetroHistoryV2(d.retrospects || []); setRetroPatterns(d.patterns || []); setRetroRatingAvg(d.ratingAvg || null); }
                        alert("å¤ç›˜å·²ä¿å­˜");
                      }
                    }}>ä¿å­˜å¤ç›˜</button>
                    <button className="btn btn-outline" onClick={async () => {
                      // å°†å½“å‰ç»“æ„ä¿å­˜ä¸ºæ¨¡æ¿ï¼ˆä»…é—®é¢˜ç»“æ„ï¼‰
                      if (!templateDraft) return;
                      const title = prompt("æ¨¡æ¿åç§°", templateDraft.title || "æˆ‘çš„æ¨¡æ¿");
                      if (!title) return;
                      const questions = (mixBlocks || []).filter((b) => b.type === "question").map((b) => ({ type: b.qType || "text", question: b.question || "é—®é¢˜", max: b.max || 5 }));
                      const res = await fetch(apiUrl("retrospect-templates"), {
                        method: "POST",
                        headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
                        body: JSON.stringify({ title, description: "", category: "è‡ªå®šä¹‰", isPublic: false, questions }),
                      });
                      const data = await res.json();
                      if (data.error) alert(data.error);
                      else {
                        alert("å·²ä¿å­˜ä¸ºæ¨¡æ¿");
                        const tRes = await fetch(apiUrl("retrospect-templates"), { headers: { Authorization: "Bearer " + token } });
                        const tData = await tRes.json();
                        if (!tData.error) { setTplMine(tData.mine || []); setTplSystem(tData.system || []); }
                      }
                    }}>å¦å­˜ä¸ºæ¨¡æ¿</button>
                  </div>
                </div>

                {/* å¡«å†™å¤ç›˜ */}
                <div className="finance-card" style={{ marginTop: 12 }}>
                  <h4>âœï¸ å¡«å†™ä¸ä¿å­˜</h4>
                  {(() => {
                    const all = [...(tplMine || []), ...(tplSystem || [])];
                    const tpl = all.find((t) => t.id === selectedTemplateId) || all[0];
                    if (!tpl) return <p style={{ color: "#666" }}>æš‚æ— æ¨¡æ¿</p>;
                    return (
                      <div className="retro-form">
                        <div style={{ fontSize: 12, color: "#666" }}>
                          <strong>{tpl.title}</strong> Â· {tpl.description || "æ— æè¿°"} Â· åˆ†ç±»ï¼š{tpl.category || "-"}
                        </div>
                        <input id="retro-fill-title" placeholder="æœ¬æ¬¡å¤ç›˜æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰" style={{ padding: "10px 12px", borderRadius: 12, border: "1px solid #ccc" }} />
                        {(tpl.questions || []).map(function (q, idx) {
                          const qid = idx;
                          const val = fillAnswers[qid];
                          if (q.type === "rating") {
                            const max = q.max || 5;
                            return (
                              <div key={idx}>
                                <div style={{ fontSize: 13, marginBottom: 6 }}>{idx + 1}. {q.question}ï¼ˆ1-{max}ï¼‰</div>
                                <select value={val == null ? "" : val} onChange={(e) => setFillAnswers({ ...fillAnswers, [qid]: Number(e.target.value) })} style={{ padding: "10px 12px", borderRadius: 12, border: "1px solid #ccc", width: "100%" }}>
                                  <option value="">è¯·é€‰æ‹©</option>
                                  {Array.from({ length: max }).map((_, i) => <option key={i + 1} value={i + 1}>{i + 1}</option>)}
                                </select>
                              </div>
                            );
                          }
                          // é»˜è®¤æ–‡æœ¬é¢˜
                          return (
                            <div key={idx}>
                              <div style={{ fontSize: 13, marginBottom: 6 }}>{idx + 1}. {q.question}</div>
                              <textarea value={val || ""} onChange={(e) => setFillAnswers({ ...fillAnswers, [qid]: e.target.value })} placeholder="å†™ä¸‹ä½ çš„ç­”æ¡ˆ..." />
                            </div>
                          );
                        })}
                        <button className="btn btn-primary" onClick={async () => {
                          const title = (document.getElementById("retro-fill-title").value || "").trim() || tpl.title;
                          const answers = (tpl.questions || []).map(function (_, idx) {
                            return { questionId: idx, answer: fillAnswers[idx] == null ? "" : fillAnswers[idx] };
                          });
                          const res = await fetch(apiUrl("retrospects"), {
                            method: "POST",
                            headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
                            body: JSON.stringify({ type: "quick", title, templateId: tpl.id, answers }),
                          });
                          const data = await res.json();
                          if (data.error) alert(data.error);
                          else {
                            window.localStorage.setItem("lastTemplateId", String(tpl.id));
                            setFillAnswers({});
                            const r = await fetch(apiUrl("retrospects"), { headers: { Authorization: "Bearer " + token } });
                            const d = await r.json();
                            if (!d.error) { setRetrospectHistory(d.retrospects || []); setRetroPatterns(d.patterns || []); setRetroRatingAvg(d.ratingAvg || null); }
                            alert("å¤ç›˜å·²ä¿å­˜");
                          }
                        }}>ä¿å­˜å¤ç›˜</button>
                      </div>
                    );
                  })()}
                </div>

                {/* æ¨¡æ¿åˆ›å»º/ç¼–è¾‘å™¨ï¼ˆç®€åŒ–ç‰ˆï¼‰ */}
                {templateDraft && (
                  <div className="finance-card" style={{ marginTop: 12 }}>
                    <h4>ğŸ§© æ¨¡æ¿ç¼–è¾‘å™¨ï¼ˆç®€åŒ–ç‰ˆï¼‰</h4>
                    <div className="retro-form">
                      <input value={templateDraft.title} onChange={(e) => setTemplateDraft({ ...templateDraft, title: e.target.value })} placeholder="æ¨¡æ¿åç§°" style={{ padding: "10px 12px", borderRadius: 12, border: "1px solid #ccc" }} />
                      <input value={templateDraft.category} onChange={(e) => setTemplateDraft({ ...templateDraft, category: e.target.value })} placeholder="åˆ†ç±»ï¼ˆå¦‚ï¼šé€šç”¨/å·¥ä½œ/å­¦ä¹ ï¼‰" style={{ padding: "10px 12px", borderRadius: 12, border: "1px solid #ccc" }} />
                      <input value={templateDraft.description} onChange={(e) => setTemplateDraft({ ...templateDraft, description: e.target.value })} placeholder="æ¨¡æ¿æè¿°ï¼ˆå¯é€‰ï¼‰" style={{ padding: "10px 12px", borderRadius: 12, border: "1px solid #ccc" }} />
                      <label style={{ display: "flex", alignItems: "center", gap: 8, fontSize: 13 }}>
                        <input type="checkbox" checked={!!templateDraft.isPublic} onChange={(e) => setTemplateDraft({ ...templateDraft, isPublic: e.target.checked })} />
                        å…¬å¼€åˆ†äº«
                      </label>
                      <div style={{ fontSize: 12, color: "#666" }}>é—®é¢˜åˆ—è¡¨ï¼ˆæ”¯æŒ æ–‡æœ¬ / è¯„åˆ†ï¼‰</div>
                      {(templateDraft.questions || []).map(function (q, idx) {
                        return (
                          <div key={idx} style={{ border: "1px solid #eee", borderRadius: 12, padding: 10 }}>
                            <div style={{ display: "flex", gap: 10, flexWrap: "wrap" }}>
                              <select value={q.type} onChange={(e) => {
                                const qs = templateDraft.questions.slice();
                                qs[idx] = { ...qs[idx], type: e.target.value };
                                setTemplateDraft({ ...templateDraft, questions: qs });
                              }} style={{ padding: "8px 10px", borderRadius: 10, border: "1px solid #ccc" }}>
                                <option value="text">æ–‡æœ¬</option>
                                <option value="rating">è¯„åˆ†</option>
                              </select>
                              <input value={q.question} onChange={(e) => {
                                const qs = templateDraft.questions.slice();
                                qs[idx] = { ...qs[idx], question: e.target.value };
                                setTemplateDraft({ ...templateDraft, questions: qs });
                              }} placeholder="é—®é¢˜å†…å®¹" style={{ flex: 1, minWidth: 220, padding: "8px 10px", borderRadius: 10, border: "1px solid #ccc" }} />
                              {q.type === "rating" && (
                                <input value={q.max || 5} onChange={(e) => {
                                  const qs = templateDraft.questions.slice();
                                  qs[idx] = { ...qs[idx], max: Number(e.target.value || 5) };
                                  setTemplateDraft({ ...templateDraft, questions: qs });
                                }} placeholder="max" style={{ width: 80, padding: "8px 10px", borderRadius: 10, border: "1px solid #ccc" }} />
                              )}
                              <button className="btn btn-outline" style={{ padding: "6px 10px" }} onClick={() => {
                                const qs = templateDraft.questions.slice();
                                qs.splice(idx, 1);
                                setTemplateDraft({ ...templateDraft, questions: qs });
                              }}>åˆ é™¤</button>
                            </div>
                          </div>
                        );
                      })}
                      <button className="btn btn-outline" onClick={() => setTemplateDraft({ ...templateDraft, questions: [...templateDraft.questions, { type: "text", question: "æ–°é—®é¢˜â€¦" }] })}>+ æ·»åŠ é—®é¢˜</button>
                      <div style={{ display: "flex", gap: 10 }}>
                        <button className="btn btn-outline" onClick={() => setTemplateDraft(null)}>å–æ¶ˆ</button>
                        <button className="btn btn-primary" onClick={async () => {
                          if (!templateDraft.title || !templateDraft.questions || templateDraft.questions.length === 0) { alert("è¯·å¡«å†™æ¨¡æ¿åç§°å’Œè‡³å°‘ä¸€ä¸ªé—®é¢˜"); return; }
                          const res = await fetch(apiUrl("retrospect-templates"), {
                            method: "POST",
                            headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
                            body: JSON.stringify(templateDraft),
                          });
                          const data = await res.json();
                          if (data.error) alert(data.error);
                          else {
                            alert("æ¨¡æ¿å·²ä¿å­˜åˆ°æˆ‘çš„æ¨¡æ¿åº“");
                            setTemplateDraft(null);
                            const tRes = await fetch(apiUrl("retrospect-templates"), { headers: { Authorization: "Bearer " + token } });
                            const tData = await tRes.json();
                            if (!tData.error) { setTplMine(tData.mine || []); setTplSystem(tData.system || []); }
                          }
                        }}>ä¿å­˜æ¨¡æ¿</button>
                      </div>
                    </div>
                  </div>
                )}

                <div className="finance-card" style={{ marginTop: 12 }}>
                  <h4>ç®€æ˜“æ¨¡å¼åˆ†æï¼ˆæœ€è¿‘ 10 æ¡ï¼‰</h4>
                  {(retroPatterns || []).map(function (p, i) {
                    return <div key={i} style={{ fontSize: 13, padding: "4px 0" }}>â€¢ {p.word}ï¼ˆ{p.count} æ¬¡ï¼‰</div>;
                  })}
                  {retroRatingAvg != null && <div style={{ fontSize: 12, color: "#666", marginTop: 6 }}>è¯„åˆ†é¢˜å¹³å‡å€¼ï¼š{retroRatingAvg}</div>}
                  {(!retroPatterns || retroPatterns.length === 0) && <p style={{ fontSize: 12, color: "#666" }}>è¿˜æ²¡æœ‰å¤ç›˜æ•°æ®</p>}
                </div>

                <div className="finance-card" style={{ marginTop: 12 }}>
                  <h4>å¤ç›˜å†å²</h4>
                  <ul className="retro-list">
                    {(retroHistoryV2 || []).slice(0, 10).map(function (r) {
                      const all = [...(tplMine || []), ...(tplSystem || [])];
                      const tpl = r.qaData && r.qaData.template_id ? all.find((t) => t.id === r.qaData.template_id) : null;
                      return (
                        <li key={r.id}>
                          <div style={{ fontWeight: 600 }}>
                            {r.title}
                            <span style={{ fontSize: 12, color: "#666" }}>ï¼ˆ{new Date(r.createdAt).toLocaleString("zh-CN")}ï¼‰</span>
                          </div>
                          <div style={{ fontSize: 12, color: "#666", marginTop: 4 }}>
                            æ¨¡å¼ï¼š{r.contentType === "free_text" ? "çº¯æ–‡æœ¬" : "å¼•å¯¼æ··åˆ"} Â· æ¨¡æ¿ï¼š{tpl ? tpl.title : "-"}
                          </div>
                          {r.contentType === "free_text" && r.freeContent && (
                            <div style={{ fontSize: 12, color: "#444", marginTop: 6, whiteSpace: "pre-wrap" }}>{String(r.freeContent).slice(0, 200)}</div>
                          )}
                          {r.contentType !== "free_text" && r.qaData && (
                            <div style={{ fontSize: 12, color: "#444", marginTop: 6 }}>
                              {(r.qaData.questions || []).slice(0, 2).map((q, idx) => <div key={idx}>â€¢ {q.question}ï¼š{String(q.answer)}</div>)}
                              {(r.qaData.free_sections || []).slice(0, 1).map((s, idx) => <div key={idx}>â€¢ è‡ªç”±ï¼š{String(s.content).slice(0, 80)}</div>)}
                            </div>
                          )}
                        </li>
                      );
                    })}
                  </ul>
                </div>
              </div>
            )}

            {feedbackData && (
              <div className="feedback-overlay" onClick={() => { setFeedbackData(null); refreshHome(); }}>
                <div className="feedback-modal" onClick={(e) => e.stopPropagation()}>
                  <h3>ğŸ‰ ä»»åŠ¡å®Œæˆï¼</h3>
                  <div className="feedback-rewards">
                    {feedbackData.rewards.xp > 0 && (
                      <div className="feedback-row gain">ç»éªŒ +{feedbackData.rewards.xp}</div>
                    )}
                    {feedbackData.rewards.coins > 0 && (
                      <div className="feedback-row gain">é‡‘å¸ +{feedbackData.rewards.coins}</div>
                    )}
                    {feedbackData.rewards.elementInteractions && feedbackData.rewards.elementInteractions.length > 0 && (
                      <div className="feedback-row" style={{ flexDirection: "column", alignItems: "flex-start", gap: 4 }}>
                        <span style={{ fontSize: 12, color: "#666" }}>ç”Ÿå…‹</span>
                        {feedbackData.rewards.elementInteractions.map(function (msg, i) {
                          return <div key={i} className="feedback-row gain" style={{ fontSize: 13 }}>{msg}</div>;
                        })}
                      </div>
                    )}
                    {feedbackData.rewards.attributes && Object.keys(feedbackData.rewards.attributes).some(function (k) { return feedbackData.rewards.attributes[k] !== 0; }) && (
                      <div className="feedback-row">
                        <span>å±æ€§å˜åŒ–</span>
                        <span className="feedback-attr">
                          {Object.keys(feedbackData.rewards.attributes).map(function (k) {
                            const v = feedbackData.rewards.attributes[k];
                            if (v === 0) return null;
                            return <span key={k}>{ATTR_NAMES[k]}{v > 0 ? "+" : ""}{v}</span>;
                          })}
                        </span>
                      </div>
                    )}
                    {feedbackData.rewards.skillUps && feedbackData.rewards.skillUps.length > 0 && (
                      <div className="feedback-row gain">
                        æŠ€èƒ½å‡çº§ï¼š{feedbackData.rewards.skillUps.map(function (s) { return s.skillName + " Lv." + s.newLevel; }).join("ã€")}
                      </div>
                    )}
                    {feedbackData.rewards.achievements && feedbackData.rewards.achievements.length > 0 && (
                      <div>
                        {feedbackData.rewards.achievements.map(function (a, i) {
                          return (
                            <div key={i} className="feedback-achievement">
                              <strong>ğŸ† {a.name}</strong>
                              {a.description}
                            </div>
                          );
                        })}
                      </div>
                    )}
                  </div>
                  <div style={{ display: "flex", gap: 10 }}>
                    <button className="btn btn-outline" onClick={() => setFeedbackData(null)}>
                      å…³é—­
                    </button>
                    <button className="btn btn-primary" onClick={() => { setShowQuickRetro(true); }}>
                      å¿«é€Ÿå¤ç›˜
                    </button>
                  </div>
                </div>
              </div>
            )}

            {showQuickRetro && (
              <div className="modal-overlay" onClick={() => setShowQuickRetro(false)}>
                <div className="modal" onClick={(e) => e.stopPropagation()}>
                  <h3>ğŸ§  å¿«é€Ÿå¤ç›˜ï¼ˆæ¨¡æ¿ï¼‰</h3>
                  <p style={{ fontSize: 12, color: "#666" }}>é€‰æ‹©æ¨¡æ¿å¹¶å›ç­”é—®é¢˜</p>
                  <select
                    value={selectedTemplateId || ""}
                    onChange={(e) => { setSelectedTemplateId(Number(e.target.value)); setFillAnswers({}); window.localStorage.setItem("lastTemplateId", e.target.value); }}
                    style={{ padding: "10px 12px", borderRadius: 12, border: "1px solid #ccc", width: "100%", marginBottom: 8 }}
                  >
                    <optgroup label="â­ æˆ‘çš„æ¨¡æ¿">
                      {(tplMine || []).map((t) => <option key={t.id} value={t.id}>{t.title}</option>)}
                    </optgroup>
                    <optgroup label="ğŸ§  ç³»ç»Ÿæ¨¡æ¿">
                      {(tplSystem || []).map((t) => <option key={t.id} value={t.id}>{t.title}</option>)}
                    </optgroup>
                  </select>
                  <input id="quick-retro-title" defaultValue={feedbackData && feedbackData.task ? feedbackData.task.title : ""} placeholder="æœ¬æ¬¡å¤ç›˜æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰" style={{ padding: "10px 12px", borderRadius: 12, border: "1px solid #ccc", width: "100%", marginBottom: 8 }} />
                  {(() => {
                    const all = [...(tplMine || []), ...(tplSystem || [])];
                    const tpl = all.find((t) => t.id === selectedTemplateId) || all[0];
                    if (!tpl) return null;
                    return (tpl.questions || []).map(function (q, idx) {
                      const qid = idx;
                      const val = fillAnswers[qid];
                      if (q.type === "rating") {
                        const max = q.max || 5;
                        return (
                          <div key={idx} style={{ marginBottom: 8 }}>
                            <div style={{ fontSize: 13, marginBottom: 6 }}>{idx + 1}. {q.question}ï¼ˆ1-{max}ï¼‰</div>
                            <select value={val == null ? "" : val} onChange={(e) => setFillAnswers({ ...fillAnswers, [qid]: Number(e.target.value) })} style={{ padding: "10px 12px", borderRadius: 12, border: "1px solid #ccc", width: "100%" }}>
                              <option value="">è¯·é€‰æ‹©</option>
                              {Array.from({ length: max }).map((_, i) => <option key={i + 1} value={i + 1}>{i + 1}</option>)}
                            </select>
                          </div>
                        );
                      }
                      return (
                        <textarea
                          key={idx}
                          placeholder={`${idx + 1}. ${q.question}`}
                          value={val || ""}
                          onChange={(e) => setFillAnswers({ ...fillAnswers, [qid]: e.target.value })}
                          style={{ width: "100%", minHeight: 60, padding: 10, borderRadius: 12, border: "1px solid #ccc", marginBottom: 6 }}
                        />
                      );
                    });
                  })()}
                  <div className="actions">
                    <button className="btn btn-outline" onClick={() => setShowQuickRetro(false)}>å–æ¶ˆ</button>
                    <button
                      className="btn btn-primary"
                      onClick={async () => {
                        const all = [...(tplMine || []), ...(tplSystem || [])];
                        const tpl = all.find((t) => t.id === selectedTemplateId) || all[0];
                        if (!tpl) { alert("æ²¡æœ‰å¯ç”¨æ¨¡æ¿"); return; }
                        const title = (document.getElementById("quick-retro-title").value || "").trim() || tpl.title;
                        const answers = (tpl.questions || []).map(function (_, idx) {
                          return { questionId: idx, answer: fillAnswers[idx] == null ? "" : fillAnswers[idx] };
                        });
                        try {
                          const res = await fetch(apiUrl("retrospects"), {
                            method: "POST",
                            headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
                            body: JSON.stringify({ type: "quick", title, templateId: tpl.id, answers }),
                          });
                          const data = await res.json();
                          if (data.error) alert(data.error);
                          else {
                            setShowQuickRetro(false);
                            window.localStorage.setItem("lastTemplateId", String(tpl.id));
                            setFillAnswers({});
                            alert("å¤ç›˜å·²ä¿å­˜");
                          }
                        } catch (e) { alert("æäº¤å¤±è´¥"); }
                      }}
                    >
                      ä¿å­˜
                    </button>
                  </div>
                </div>
              </div>
            )}

            {challengeDetail && (
              <div className="challenge-detail-overlay" onClick={() => setChallengeDetail(null)}>
                <div className="challenge-detail-modal" onClick={(e) => e.stopPropagation()}>
                  <h3>ğŸ“Œ {challengeDetail.challenge.title}</h3>
                  <p className="subtitle">æŠ€èƒ½è¦æ±‚ vs å½“å‰ç­‰çº§ Â· ä¸‹ä¸€æ­¥è¯¥ç»ƒä»€ä¹ˆ</p>
                  <div className="skill-dashboard">
                    {(challengeDetail.skillStatus || []).map(function (s, i) {
                      const icon = s.status === "met" ? "âœ…" : s.status === "in_progress" ? "ğŸ”„" : "â³";
                      const label = s.status === "met" ? "è¾¾æ ‡" : s.status === "in_progress" ? "è¿›è¡Œä¸­" : "æœªå¼€å§‹";
                      return (
                        <div key={i} className={"skill-status-row " + s.status}>
                          <span>{icon} {s.skillName}</span>
                          <span>
                            éœ€è¦ Lv.{s.requiredLevel} Â· å½“å‰ Lv.{s.currentLevel}
                            <span style={{ marginLeft: 6, color: "#666", fontSize: 12 }}>{label}</span>
                          </span>
                        </div>
                      );
                    })}
                  </div>
                  <button className="btn btn-primary" style={{ width: "100%", marginTop: 12 }} onClick={() => setChallengeDetail(null)}>
                    å…³é—­
                  </button>
                </div>
              </div>
            )}
          </div>
        );
      }

      function App() {
        const [token, setToken] = useState(null);
        const [user, setUser] = useState(null);

        const handleLoggedIn = (t, u) => {
          try {
            window.localStorage.setItem("token", t);
          } catch (e) {}
          setToken(t);
          setUser(u);
        };

        return (
          <div>
            <div className="title">äººç”Ÿç©å®¶</div>
            {!token ? (
              <div style={{ minHeight: "65vh", display: "flex", alignItems: "center", justifyContent: "center" }}>
                <LoginCard onLoggedIn={handleLoggedIn} />
              </div>
            ) : (
              <Dashboard token={token} user={user} />
            )}
          </div>
        );
      }

      try {
        ReactDOM.createRoot(document.getElementById("root")).render(<App />);
      } catch (e) {
        var root = document.getElementById("root");
        if (root) root.innerHTML = "<div style='padding:24px;text-align:center;background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border-radius:16px;border:1px solid rgba(255,255,255,0.2)'><p style='color:#c62828;font-weight:600;margin-bottom:8px'>âš  è„šæœ¬åŠ è½½å¤±è´¥</p><p style='font-size:13px;color:#333;margin-top:8px'>è¯·ç”¨æœ¬åœ°æœåŠ¡å™¨æ‰“å¼€ï¼šåœ¨ã€Œäººç”Ÿæ¸¸æˆã€ç›®å½•è¿è¡Œ <strong>npx serve frontend</strong>ï¼Œç„¶åè®¿é—® http://localhost:3000</p><p style='font-size:12px;color:#666;margin-top:12px'>æˆ–æŒ‰ F12 æŸ¥çœ‹æ§åˆ¶å°æŠ¥é”™</p></div>";
      }
    </script>
    <script>
      setTimeout(function() {
        var fallback = document.getElementById("load-fallback");
        if (fallback) {
          fallback.innerHTML = "<p style='margin-bottom:8px;color:#c62828;font-weight:600'>âš  é¡µé¢åŠ è½½å¤±è´¥</p><p style='font-size:13px;color:#333'>è„šæœ¬æœªæˆåŠŸåŠ è½½æˆ–æ‰§è¡Œã€‚è¯·æŒ‰ <strong>F12</strong> æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼Œåœ¨ã€ŒConsole/æ§åˆ¶å°ã€é‡ŒæŸ¥çœ‹çº¢è‰²æŠ¥é”™ä¿¡æ¯ã€‚</p><p style='font-size:12px;color:#666;margin-top:10px'>è‹¥ä¸ºç½‘ç»œé—®é¢˜ï¼Œå¯æ£€æŸ¥æ˜¯å¦èƒ½è®¿é—® unpkg.comï¼›è‹¥ä¸ºè„šæœ¬æŠ¥é”™ï¼Œè¯·å°†æ§åˆ¶å°ä¸­çš„æŠ¥é”™å†…å®¹åé¦ˆä»¥ä¾¿æ’æŸ¥ã€‚</p>";
        }
      }, 5000);
    </script>
  </body>
</html>

